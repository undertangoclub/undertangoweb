<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Tango (Edición por clic)</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #1a0f0a;
        color: #d4a574;
        margin: 0;
        padding: 10px;
        min-height: 100vh;
        box-sizing: border-box;
      }

      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        display: block;
        gap: 15px;
      }

      .month {
        width: 100%;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .month-header {
        margin-bottom: 15px;
        padding: 10px;
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
          url("https://hebbkx1anhila5yf.public.blob.vercel-storage.com/11-2024-9vRUE8b2vSmqweM2I7CJw1H9gdAt6k.png");
        background-size: cover;
        background-position: center;
        border-radius: 8px;
      }

      .month-header h2 {
        color: #ffd700;
        margin: 0;
        font-size: 1.8rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        text-align: center;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .weekday {
        text-align: center;
        padding: 6px;
        font-weight: bold;
        color: #ffd700;
        font-size: 1rem;
      }

      .day {
        aspect-ratio: 1;
        background-color: rgba(62, 39, 35, 0.5);
        border: 1px solid #4a2f2a;
        padding: 6px;
        min-height: 60px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: grid;
        grid-template-rows: repeat(5, 1fr);
        grid-template-columns: 1fr 2fr 1fr;
        gap: 2px;
        overflow-y: auto;
      }

      .day:hover {
        background-color: rgba(82, 49, 45, 0.7);
      }

      .day-number {
        grid-column: 1 / span 3;
        text-align: center;
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 1rem;
      }

      .time-slot {
        text-align: center;
        font-size: 0.8rem;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 4px;
        padding: 2px;
        color: #ffd700;
        cursor: pointer;
      }

      .location-slot {
        text-align: center;
        font-size: 0.8rem;
        background-color: rgba(62, 39, 35, 0.9);
        border-radius: 4px;
        padding: 2px;
        color: #d4a574;
        cursor: pointer;
      }

      .performer-slot {
        text-align: center;
        font-size: 0.8rem;
        background-color: rgba(82, 49, 45, 0.9);
        border-radius: 4px;
        padding: 2px;
        color: #ffd700;
        cursor: pointer;
      }

      .referencias {
        margin-top: 20px;
      }

      .referencias .tooltip {
        visibility: hidden;
        width: 200px;
        background-color: rgba(41, 27, 23, 0.9);
        color: #d4a574;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        top: 100%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .referencias:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          gap: 10px;
        }

        .month {
          min-width: 100%;
          max-width: 100%;
        }

        .calendar-grid {
          grid-template-columns: repeat(7, 1fr);
        }

        .day {
          min-height: 50px;
          font-size: 0.8rem;
        }

        .month-header h2 {
          font-size: 1.2rem;
        }
      }

      @media (max-width: 480px) {
        .calendar-grid {
          grid-template-columns: repeat(7, 1fr);
        }

        .day {
          min-height: 40px;
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Enero -->
      <div class="month">
        <div class="month-header">
          <h2>Enero 2025</h2>
        </div>
        <div class="calendar-grid">
          <div class="weekday">Dom</div>
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mié</div>
          <div class="weekday">Jue</div>
          <div class="weekday">Vie</div>
          <div class="weekday">Sáb</div>
        </div>
      </div>

      <!-- Febrero -->
      <div class="month">
        <div class="month-header">
          <h2>Febrero 2025</h2>
        </div>
        <div class="calendar-grid">
          <div class="weekday">Dom</div>
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mié</div>
          <div class="weekday">Jue</div>
          <div class="weekday">Vie</div>
          <div class="weekday">Sáb</div>
        </div>
      </div>
    </div>

    <div class="referencias">
      Referencias
      <span class="tooltip">
        Ø = Bianca y Pablo<br />
        TyM = Tiki y Meli<br />
        YyD = Yesi y Dennis<br />
        x2 = doble turno<br />
        Cr = Cruceros<br />
        CM = Casa Malbec<br />
        DAM = DAM
      </span>
    </div>

    <script>
      // ================================
      // CONFIGURACIÓN DE AIRTABLE
      // ================================
      // Ajusta estas constantes con tus propios datos
      const AIRTABLE_TOKEN =
        "patuKKtlyfqvVNCpc.25468d0bda6badcfd90c84a03a681fc462c0b66b57b964eddb0449b24134a45e"; // Tu token personal
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      const TABLE_NAME = "calendario";

      // ================================
      // CREACIÓN DE LA ESTRUCTURA DEL CALENDARIO
      // ================================
      function createCalendarDays(calendarGrid, year, month) {
        // Guarda las cabeceras originales (Dom, Lun, etc.)
        const weekdays = Array.from(calendarGrid.querySelectorAll(".weekday"));

        // Limpia la grilla
        calendarGrid.innerHTML = "";
        // Reinsertamos las cabeceras
        weekdays.forEach((day) => calendarGrid.appendChild(day));

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startingDay = firstDay.getDay();

        // Espacios vacíos antes del primer día
        for (let i = 0; i < startingDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "day";
          calendarGrid.appendChild(emptyDay);
        }

        // Crea los días y slots
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dayElement = document.createElement("div");
          dayElement.className = "day";
          dayElement.innerHTML = `<div class="day-number">${day}</div>`;

          // Creamos 5 filas de slots
          for (let i = 0; i < 5; i++) {
            dayElement.innerHTML += `
              <div class="time-slot" onclick="editSlot(this, 'hora')">Hora ${
                i + 1
              }</div>
              <div class="location-slot" onclick="editSlot(this, 'lugar')">Lugar ${
                i + 1
              }</div>
              <div class="performer-slot" onclick="editSlot(this, 'interprete')">Intérprete ${
                i + 1
              }</div>
            `;
          }
          calendarGrid.appendChild(dayElement);
        }
      }

      // Inicializa los dos meses (Enero y Febrero)
      function initializeCalendars() {
        const januaryGrid = document.querySelector(
          ".month:first-child .calendar-grid"
        );
        const februaryGrid = document.querySelector(
          ".month:last-child .calendar-grid"
        );

        createCalendarDays(januaryGrid, 2025, 0);
        createCalendarDays(februaryGrid, 2025, 1);
      }

      // ================================
      // CARGAR EVENTOS DESDE AIRTABLE
      // ================================
      async function loadEvents() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${AIRTABLE_TOKEN}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          displayEvents(data.records);
        } catch (error) {
          console.error("Error cargando eventos:", error);
          alert("Error al cargar los eventos de Airtable");
        }
      }

      // Muestra los eventos en cada día
      function displayEvents(records) {
        records.forEach((record) => {
          const { fields } = record;
          // Asumimos que 'fecha' en Airtable guarda fecha (o fecha+hora)
          if (fields.fecha) {
            const date = new Date(fields.fecha);
            const dayElement = findDayElement(date);

            if (dayElement) {
              // Busca el primer slot libre para 'hora'
              if (fields.hora) {
                const timeSlot = dayElement.querySelector(
                  ".time-slot:not([data-id])"
                );
                if (timeSlot) {
                  timeSlot.textContent = fields.hora;
                  timeSlot.setAttribute("data-id", record.id);
                }
              }
              // Lo mismo para 'lugar'
              if (fields.lugar) {
                const locationSlot = dayElement.querySelector(
                  ".location-slot:not([data-id])"
                );
                if (locationSlot) {
                  locationSlot.textContent = fields.lugar;
                  locationSlot.setAttribute("data-id", record.id);
                }
              }
              // Y para 'interprete'
              if (fields.interprete) {
                const performerSlot = dayElement.querySelector(
                  ".performer-slot:not([data-id])"
                );
                if (performerSlot) {
                  performerSlot.textContent = fields.interprete;
                  performerSlot.setAttribute("data-id", record.id);
                }
              }
            }
          }
        });
      }

      // ================================
      // EDITAR SLOT (PATCH A AIRTABLE)
      // ================================
      async function editSlot(element, type) {
        const recordId = element.getAttribute("data-id");
        const currentValue = element.textContent;
        const newValue = prompt(`Editar ${type}:`, currentValue);

        if (newValue === null) return; // Usuario canceló

        // Obtener la fecha del día que se está editando
        const dayElement = element.closest(".day");
        const dayNumber = dayElement.querySelector(".day-number").textContent;
        const monthElement = dayElement.closest(".month");
        const monthHeader =
          monthElement.querySelector(".month-header h2").textContent;
        const year = 2025;
        const month = monthHeader.includes("Enero") ? 0 : 1;
        const date = new Date(year, month, parseInt(dayNumber));

        // Asegurarse de que la fecha esté en formato YYYY-MM-DD
        const formattedDate = date.toISOString().split("T")[0];

        // Actualizar UI
        element.textContent = newValue;

        try {
          if (recordId) {
            // ACTUALIZAR registro existente
            const response = await fetch(
              `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}`,
              {
                method: "PATCH",
                headers: {
                  Authorization: `Bearer ${AIRTABLE_TOKEN}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  fields: {
                    [type]: newValue,
                  },
                }),
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Error detallado:", errorData);
              throw new Error(`HTTP error! status: ${response.status}`);
            }
          } else {
            // CREAR nuevo registro con todos los campos necesarios
            const fields = {
              fecha: formattedDate,
              [type]: newValue,
            };

            // Asegurarse de que todos los campos requeridos estén presentes
            if (!fields.hora) fields.hora = "";
            if (!fields.lugar) fields.lugar = "";
            if (!fields.interprete) fields.interprete = "";

            const response = await fetch(
              `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${AIRTABLE_TOKEN}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  records: [
                    {
                      fields: fields,
                    },
                  ],
                }),
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Error detallado:", errorData);
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            // Guardar el ID del nuevo registro en el elemento
            element.setAttribute("data-id", result.records[0].id);
          }

          console.log("Operación exitosa");
        } catch (error) {
          console.error("Error completo:", error);
          alert(
            "Error al guardar en Airtable. Revisa la consola para más detalles."
          );
          // Revertir cambios en UI si hay error
          element.textContent = currentValue;
        }
      }

      // ================================
      // AYUDANTE: ENCONTRAR <div.day> CORRECTO
      // ================================
      function findDayElement(date) {
        const month = date.getMonth(); // 0 = enero, 1 = febrero
        const day = date.getDate();

        // monthSelector: si es 0 -> first-child, si es 1 -> last-child
        // (porque solo tenemos 2 meses en este ejemplo)
        const monthSelector = month === 0 ? "first-child" : "last-child";
        const monthElement = document.querySelector(`.month:${monthSelector}`);

        if (monthElement) {
          const days = monthElement.querySelectorAll(".day");
          const dayElement = Array.from(days).find((el) => {
            const dayNumber = el.querySelector(".day-number");
            return dayNumber && dayNumber.textContent === day.toString();
          });
          return dayElement;
        }
        return null;
      }

      // ================================
      // INICIALIZACIÓN
      // ================================
      document.addEventListener("DOMContentLoaded", () => {
        initializeCalendars();
        loadEvents(); // Carga los eventos y luego los muestra
      });
    </script>
  </body>
</html>
