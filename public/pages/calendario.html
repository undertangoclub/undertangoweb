<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Tango</title>
    <style>
      /* Estilo general del cuerpo */
      body {
        font-family: "Arial", sans-serif;
        background-color: #1a0f0a;
        color: #d4a574;
        margin: 0;
        padding: 10px;
        min-height: 100vh;
        box-sizing: border-box;
      }

      /* Contenedor principal */
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        display: block;
        gap: 15px;
      }

      /* Contenedor del mes */
      .month {
        width: 100%;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      /* Encabezado del mes */
      .month-header {
        margin-bottom: 15px;
        padding: 10px;
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
          url("https://hebbkx1anhila5yf.public.blob.vercel-storage.com/11-2024-9vRUE8b2vSmqweM2I7CJw1H9gdAt6k.png");
        background-size: cover;
        background-position: center;
        border-radius: 8px;
      }

      .month-header h2 {
        color: #ffd700;
        margin: 0;
        font-size: 1.8rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        text-align: center;
      }

      /* Diseño de la cuadrícula del calendario */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      /* Días de la semana: lunes primero */
      .weekday {
        text-align: center;
        padding: 6px;
        font-weight: bold;
        color: #ffd700;
        font-size: 1rem;
      }

      /* Contenedor para cada día */
      .day {
        background-color: rgba(62, 39, 35, 0.5);
        border: 1px solid #4a2f2a;
        padding: 6px;
        transition: background-color 0.3s;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow-y: auto;
        position: relative; /* Para colocar la etiqueta del día de la semana en móvil */
      }

      .day:hover {
        background-color: rgba(82, 49, 45, 0.7);
      }

      .day-number {
        text-align: center;
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 1rem;
      }

      /* Etiqueta para día de la semana en modo móvil */
      .day-week-label {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(255, 255, 255, 0.2);
        color: #ffd700;
        font-weight: bold;
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 0.8rem;
        display: none; /* Se mostrará en móvil */
      }

      /* Estilo para los eventos */
      .event {
        display: grid;
        grid-template-columns: 7ch auto 7ch;
        gap: 3px;
        font-size: 0.8rem;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 6px;
        padding: 4px;
        align-items: center;
        cursor: pointer; /* Solo si editMode está activo */
      }

      /* Por defecto */
      .hora {
        background-color: #5a382f;
        color: #ffd700;
        font-weight: bold;
        text-align: center;
        padding: 2px;
        border-radius: 3px;
      }

      .lugar {
        background-color: #71443b;
        color: #ffffff;
        text-align: center;
        padding: 2px;
        border-radius: 3px;
      }

      .interprete {
        background-color: #8a5548;
        color: #ffd700;
        text-align: center;
        padding: 2px;
        border-radius: 3px;
      }

      /* Botón "Agregar evento" */
      .add-event {
        color: #ffd700;
        font-size: 0.8rem;
        text-align: center;
        text-decoration: underline;
        line-height: normal;
        margin: 2px 0;
        white-space: nowrap;
        cursor: pointer; /* Siempre se puede añadir, aunque edición esté off */
      }

      /* Modales */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: #2c2c2c;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        max-width: 90%;
      }

      .modal-content h3 {
        color: #fff;
        margin-top: 0;
        margin-bottom: 15px;
      }

      .modal-content label {
        display: block;
        color: #fff;
        margin: 5px 0 2px;
      }

      .modal-content select,
      .modal-content input[type="color"] {
        width: 100%;
        margin-bottom: 10px;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #444;
        color: #fff;
      }

      .modal-content button {
        margin-right: 10px;
        padding: 5px 10px;
      }

      /* -- Color pickers lado derecho -- */
      .color-picker-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .color-picker-row {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .color-picker-row label {
        margin: 0;
      }

      .color-picker {
        width: 30px;
        height: 30px;
        border: none;
        background: transparent;
      }

      /* Responsivo para móviles: una sola columna */
      @media (max-width: 600px) {
        .calendar-grid {
          display: block; /* Apilamos los días uno debajo del otro */
        }
        .day {
          margin-bottom: 10px;
        }
        .day-week-label {
          display: block; /* Mostramos la etiqueta de día de la semana */
        }
        .weekday {
          display: none; /* Ocultamos encabezados de días en modo móvil */
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Mes: Enero -->
      <div class="month">
        <div class="month-header">
          <h2>Enero 2025</h2>
        </div>
        <!-- Semana comienza en lunes -->
        <div class="calendar-grid calendar-grid-ene">
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mié</div>
          <div class="weekday">Jue</div>
          <div class="weekday">Vie</div>
          <div class="weekday">Sáb</div>
          <div class="weekday">Dom</div>
        </div>
      </div>

      <!-- Mes: Febrero (NUEVO) -->
      <div class="month">
        <div class="month-header">
          <h2>Febrero 2025</h2>
        </div>
        <!-- Semana comienza en lunes -->
        <div class="calendar-grid calendar-grid-feb">
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mié</div>
          <div class="weekday">Jue</div>
          <div class="weekday">Vie</div>
          <div class="weekday">Sáb</div>
          <div class="weekday">Dom</div>
        </div>
      </div>
    </div>

    <!-- Botón para activar/desactivar modo edición -->
    <div style="text-align: center">
      <button id="edit-btn">Editar</button>
    </div>

    <script>
      const AIRTABLE_TOKEN =
        "patuKKtlyfqvVNCpc.25468d0bda6badcfd90c84a03a681fc462c0b66b57b964eddb0449b24134a45e";
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      const TABLE_NAME = "calendario";

      // Controla si se puede editar (por defecto false)
      let editMode = false;

      // Mapeo de índice a día de la semana (para la etiqueta en móvil)
      const weekMap = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];

      /**
       * Crea los recuadros de días del calendario
       * con lunes como día 0.
       */
      function createCalendarDays(calendarGrid, year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let startingDay = firstDay.getDay();
        // Ajuste para Lunes=0, Martes=1,... Domingo=6
        startingDay = (startingDay + 6) % 7;

        for (let i = 0; i < startingDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "day";
          calendarGrid.appendChild(emptyDay);
        }

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dayElement = document.createElement("div");
          dayElement.className = "day";

          // Agregamos etiqueta para día de la semana (en móvil)
          const weekdayIndex = (startingDay + (day - 1)) % 7;
          const weekdayLabel = document.createElement("div");
          weekdayLabel.className = "day-week-label";
          weekdayLabel.textContent = weekMap[weekdayIndex] || "";
          dayElement.appendChild(weekdayLabel);

          const dayNumber = document.createElement("div");
          dayNumber.className = "day-number";
          dayNumber.textContent = day;

          const addEventBlock = document.createElement("div");
          addEventBlock.className = "event add-event";
          addEventBlock.textContent = "+ Agregar evento";

          // "Agregar evento" se permite siempre,
          // independientemente de editMode
          addEventBlock.addEventListener("click", () =>
            promptNewEvent(dayElement)
          );

          dayElement.appendChild(dayNumber);
          dayElement.appendChild(addEventBlock);
          calendarGrid.appendChild(dayElement);
        }
      }

      /**
       * Carga los eventos desde Airtable
       */
      async function loadEvents() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?sort%5B0%5D%5Bfield%5D=fecha&sort%5B1%5D%5Bfield%5D=hora`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${AIRTABLE_TOKEN}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          displayEvents(data.records);
        } catch (error) {
          console.error("Error cargando eventos:", error);
        }
      }

      /**
       * Aplica estilos de color según lugar, intérprete y hora
       */
      function aplicarEstilos(eventElement, horaEl, lugarEl, interpreteEl) {
        // LUGAR
        const lugarTexto = lugarEl.textContent?.trim().toLowerCase();
        if (lugarTexto === "cruceros") {
          lugarEl.style.backgroundColor = "#2084d7";
          lugarEl.style.color = "black";
        } else if (lugarTexto === "casa malbec") {
          lugarEl.style.backgroundColor = "#771613";
          lugarEl.style.color = "#b6b6b6";
        } else if (lugarTexto === "meliá") {
          lugarEl.style.backgroundColor = "yellow";
          lugarEl.style.color = "black";
        } else if (lugarTexto === "dam-cde") {
          lugarEl.style.backgroundColor = "white";
          lugarEl.style.color = "black";
        } else if (lugarTexto === "ensayo") {
          lugarEl.style.backgroundColor = "green";
          lugarEl.style.color = "black";
        } else if (lugarTexto === "cruceros nocturno") {
          lugarEl.style.backgroundColor = "#3e56ef";
          lugarEl.style.color = "white";
        } else if (lugarTexto === "reunión marketing") {
          lugarEl.style.backgroundColor = "violet";
          lugarEl.style.color = "black";
        }

        // INTÉRPRETE
        const interpreteTexto = interpreteEl.textContent?.trim();
        const interpretesArray = interpreteTexto
          .split(",")
          .map((i) => i.trim().toLowerCase());

        interpretesArray.forEach((it) => {
          if (it === "byp") {
            interpreteEl.style.backgroundColor = "#c24444"; // Bordó
            interpreteEl.style.color = "white";
          } else if (it === "tym") {
            interpreteEl.style.backgroundColor = "darkblue";
            interpreteEl.style.color = "white";
          } else if (it === "yyd") {
            interpreteEl.style.backgroundColor = "#267713";
            interpreteEl.style.color = "white";
          } else if (it === "team-6") {
            interpreteEl.style.backgroundColor = "green";
            interpreteEl.style.color = "black";
          } else if (it === "bypys") {
            interpreteEl.style.backgroundColor = "orange";
            interpreteEl.style.color = "black";
          } else if (it === "reunión marketing") {
            interpreteEl.style.backgroundColor = "violet";
            interpreteEl.style.color = "black";
          }
        });

        // HORA (simple degradé)
        const horaTexto = horaEl.textContent?.trim();
        if (horaTexto) {
          const partes = horaTexto.split(":");
          const h = parseInt(partes[0], 10) || 0;
          if (h < 17) {
            horaEl.style.backgroundColor = "#b36155"; // claro
            horaEl.style.color = "#000";
          } else {
            horaEl.style.backgroundColor = "#5a382f";
            horaEl.style.color = "#ffd700";
          }
        }
      }

      /**
       * Muestra los eventos en el calendario
       */
      function displayEvents(records) {
        // Recolectamos los días de ambos meses:
        const eneDays = document.querySelectorAll(".calendar-grid-ene .day");
        const febDays = document.querySelectorAll(".calendar-grid-feb .day");

        records.forEach((record) => {
          const { fecha, hora, lugar, interprete } = record.fields;
          if (!fecha || !hora) {
            console.warn(
              "Registro ignorado por falta de fecha u hora:",
              record
            );
            return;
          }

          const [year, month, day] = fecha.split("-").map(Number);

          // Identificamos si corresponde a enero (0) o febrero (1):
          let dayElements = null;
          if (month === 1) {
            // enero
            dayElements = eneDays;
          } else if (month === 2) {
            // febrero
            dayElements = febDays;
          } else {
            // Si llegaran otros meses, los ignoramos
            return;
          }

          const dayElement = Array.from(dayElements).find((dayEl) => {
            const dayNumber = parseInt(
              dayEl.querySelector(".day-number")?.textContent
            );
            return dayNumber === day;
          });

          if (!dayElement) {
            console.warn("No se encontró día para el registro:", record);
            return;
          }

          const eventElement = document.createElement("div");
          eventElement.className = "event";

          const horaElement = document.createElement("div");
          horaElement.className = "hora";
          horaElement.textContent = hora;

          const lugarElement = document.createElement("div");
          lugarElement.className = "lugar";
          lugarElement.textContent = lugar || "Sin lugar";

          const interpreteElement = document.createElement("div");
          interpreteElement.className = "interprete";
          if (Array.isArray(interprete)) {
            interpreteElement.textContent = interprete.join(", ");
          } else {
            interpreteElement.textContent = interprete || "Sin intérprete";
          }

          eventElement.appendChild(horaElement);
          eventElement.appendChild(lugarElement);
          eventElement.appendChild(interpreteElement);

          aplicarEstilos(
            eventElement,
            horaElement,
            lugarElement,
            interpreteElement
          );

          // Solo abrimos el modal de edición si editMode está activo
          eventElement.addEventListener("click", () => {
            if (editMode) {
              editEvent(record.id, { fecha, hora, lugar, interprete });
            }
          });

          const addBlock = dayElement.querySelector(".add-event");
          dayElement.insertBefore(eventElement, addBlock);
        });
      }

      /**
       * Obtiene la lista de lugares desde Airtable
       */
      async function obtenerOpcionesLugares() {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
        try {
          const response = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` },
          });

          if (!response.ok) {
            throw new Error(`Error al obtener lugares: ${response.status}`);
          }

          const data = await response.json();
          const lugaresSet = new Set();

          data.records.forEach((record) => {
            const campoLugar = record.fields.lugar;
            if (campoLugar && typeof campoLugar === "string") {
              lugaresSet.add(campoLugar);
            }
          });

          return Array.from(lugaresSet);
        } catch (error) {
          console.error("Error al obtener lugares:", error);
          return [];
        }
      }

      /**
       * Obtiene la lista de intérpretes desde Airtable
       */
      async function obtenerOpcionesInterpretes() {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
        try {
          const response = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` },
          });

          if (!response.ok) {
            throw new Error(`Error al obtener intérpretes: ${response.status}`);
          }

          const data = await response.json();
          const interpretesSet = new Set();

          data.records.forEach((record) => {
            const campoInterprete = record.fields.interprete;
            if (campoInterprete) {
              if (Array.isArray(campoInterprete)) {
                campoInterprete.forEach((item) => interpretesSet.add(item));
              } else {
                interpretesSet.add(campoInterprete);
              }
            }
          });

          return Array.from(interpretesSet);
        } catch (error) {
          console.error("Error al obtener intérpretes:", error);
          return [];
        }
      }

      /**
       * Crea botones para la hora (8..23) y minutos (00,15,30,45).
       */
      function crearBotonesHora() {
        const container = document.createElement("div");

        const title = document.createElement("h4");
        title.textContent = "Seleccionar Hora:";
        title.style.margin = "4px 0";
        title.style.color = "#fff";
        container.appendChild(title);

        const horasDiv = document.createElement("div");
        horasDiv.style.display = "flex";
        horasDiv.style.flexWrap = "wrap";
        horasDiv.style.gap = "4px";

        let horaSeleccionada = "08";
        let minSeleccionado = "00";

        for (let h = 8; h <= 23; h++) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = h.toString().padStart(2, "0");
          btn.style.padding = "5px 8px";
          btn.style.marginBottom = "5px";

          btn.addEventListener("click", () => {
            horaSeleccionada = h.toString().padStart(2, "0");
            actualizarEstilosBotones(horasDiv, btn);
          });
          horasDiv.appendChild(btn);
        }
        container.appendChild(horasDiv);

        const minsDiv = document.createElement("div");
        minsDiv.style.display = "flex";
        minsDiv.style.flexWrap = "wrap";
        minsDiv.style.gap = "4px";
        minsDiv.style.marginTop = "8px";

        const minutosPosibles = ["00", "15", "30", "45"];
        minutosPosibles.forEach((m) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = m;
          btn.style.padding = "5px 8px";
          btn.style.marginBottom = "5px";
          btn.addEventListener("click", () => {
            minSeleccionado = m;
            actualizarEstilosBotones(minsDiv, btn);
          });
          minsDiv.appendChild(btn);
        });
        container.appendChild(minsDiv);

        function actualizarEstilosBotones(containerDiv, activoBtn) {
          Array.from(containerDiv.querySelectorAll("button")).forEach((b) => {
            b.style.backgroundColor = "#444";
            b.style.color = "#fff";
          });
          activoBtn.style.backgroundColor = "yellow";
          activoBtn.style.color = "#000";
        }

        function getHoraFinal() {
          return `${horaSeleccionada}:${minSeleccionado}`;
        }

        return { container, getHoraFinal };
      }

      /**
       * Devuelve 3 pares de color pickers (fondo/texto) para Hora, Lugar, Intérprete
       * (No se guarda en la base en este ejemplo)
       */
      function crearColorPickers() {
        const colorContainer = document.createElement("div");
        colorContainer.className = "color-picker-container";

        // Hora
        const rowHora = document.createElement("div");
        rowHora.className = "color-picker-row";
        const labelHora = document.createElement("label");
        labelHora.textContent = "Hora:";
        const inputHoraFondo = document.createElement("input");
        inputHoraFondo.type = "color";
        inputHoraFondo.className = "color-picker";
        inputHoraFondo.value = "#5a382f";
        const inputHoraTexto = document.createElement("input");
        inputHoraTexto.type = "color";
        inputHoraTexto.className = "color-picker";
        inputHoraTexto.value = "#ffd700";

        rowHora.appendChild(labelHora);
        rowHora.appendChild(inputHoraFondo);
        rowHora.appendChild(inputHoraTexto);

        // Lugar
        const rowLugar = document.createElement("div");
        rowLugar.className = "color-picker-row";
        const labelLugar = document.createElement("label");
        labelLugar.textContent = "Lugar:";
        const inputLugarFondo = document.createElement("input");
        inputLugarFondo.type = "color";
        inputLugarFondo.className = "color-picker";
        inputLugarFondo.value = "#71443b";
        const inputLugarTexto = document.createElement("input");
        inputLugarTexto.type = "color";
        inputLugarTexto.className = "color-picker";
        inputLugarTexto.value = "#ffffff";

        rowLugar.appendChild(labelLugar);
        rowLugar.appendChild(inputLugarFondo);
        rowLugar.appendChild(inputLugarTexto);

        // Intérprete
        const rowInter = document.createElement("div");
        rowInter.className = "color-picker-row";
        const labelInter = document.createElement("label");
        labelInter.textContent = "Intérprete:";
        const inputInterFondo = document.createElement("input");
        inputInterFondo.type = "color";
        inputInterFondo.className = "color-picker";
        inputInterFondo.value = "#8a5548";
        const inputInterTexto = document.createElement("input");
        inputInterTexto.type = "color";
        inputInterTexto.className = "color-picker";
        inputInterTexto.value = "#ffd700";

        rowInter.appendChild(labelInter);
        rowInter.appendChild(inputInterFondo);
        rowInter.appendChild(inputInterTexto);

        colorContainer.appendChild(rowHora);
        colorContainer.appendChild(rowLugar);
        colorContainer.appendChild(rowInter);

        function getColorValues() {
          return {
            horaFondo: inputHoraFondo.value,
            horaTexto: inputHoraTexto.value,
            lugarFondo: inputLugarFondo.value,
            lugarTexto: inputLugarTexto.value,
            interFondo: inputInterFondo.value,
            interTexto: inputInterTexto.value,
          };
        }

        return { colorContainer, getColorValues };
      }

      /**
       * Modal para crear un nuevo evento
       */
      async function promptNewEvent(dayElement) {
        const dayNumber = dayElement.querySelector(".day-number")?.textContent;
        if (!dayNumber) return;

        const monthHeader = dayElement
          .closest(".month")
          ?.querySelector(".month-header h2")?.textContent;
        const year = 2025;
        let month = 0;
        if (monthHeader.includes("Enero")) {
          month = 0; // enero
        } else if (monthHeader.includes("Febrero")) {
          month = 1; // febrero
        }
        const dateObj = new Date(year, month, parseInt(dayNumber));
        const isoDate = dateObj.toISOString().split("T")[0];

        const lugares = await obtenerOpcionesLugares();
        const interpretes = await obtenerOpcionesInterpretes();

        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";

        const modal = document.createElement("div");
        modal.className = "modal-content";

        modal.innerHTML = `
          <h3>Nuevo Evento</h3>
          <label for="lugar-select">Lugar:</label>
          <select id="lugar-select" size="5"></select>
          <label for="interprete-select">Intérprete(s):</label>
          <select id="interprete-select" multiple size="5"></select>
          <button id="guardar-btn">Guardar</button>
          <button id="cancelar-btn">Cancelar</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Insertamos el contenedor de botones para la hora
        const { container: horaContainer, getHoraFinal } = crearBotonesHora();
        // Insertamos contenedor de color pickers (a la derecha) - sin guardarlos
        const { colorContainer } = crearColorPickers();

        const containerDiv = document.createElement("div");
        containerDiv.style.display = "flex";
        containerDiv.style.justifyContent = "space-between";
        containerDiv.appendChild(horaContainer);
        containerDiv.appendChild(colorContainer);

        const lugarLabel = modal.querySelector('label[for="lugar-select"]');
        modal.insertBefore(containerDiv, lugarLabel);

        const lugarSelect = modal.querySelector("#lugar-select");
        const interpreteSelect = modal.querySelector("#interprete-select");

        lugares.forEach((l) => {
          const option = document.createElement("option");
          option.value = l;
          option.textContent = l;
          lugarSelect.appendChild(option);
        });

        interpretes.forEach((i) => {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          interpreteSelect.appendChild(option);
        });

        const guardarBtn = modal.querySelector("#guardar-btn");
        const cancelarBtn = modal.querySelector("#cancelar-btn");

        guardarBtn.addEventListener("click", async () => {
          const hora = getHoraFinal();
          const lugarValue = lugarSelect.value;
          if (!lugarValue) {
            alert("Debe seleccionar un lugar.");
            return;
          }
          const interpretesSeleccionados = Array.from(
            interpreteSelect.selectedOptions
          ).map((opt) => opt.value);
          if (!interpretesSeleccionados.length) {
            alert("Debe seleccionar al menos un intérprete.");
            return;
          }

          const fields = {
            fecha: isoDate,
            hora,
            lugar: lugarValue,
            interprete: interpretesSeleccionados,
          };

          await saveToAirtable(null, fields);
          document.body.removeChild(overlay);
          location.reload();
        });

        cancelarBtn.addEventListener("click", () => {
          document.body.removeChild(overlay);
        });
      }

      /**
       * Modal para editar un evento existente
       */
      async function editEvent(recordId, { fecha, hora, lugar, interprete }) {
        const lugares = await obtenerOpcionesLugares();
        const allInterpretes = await obtenerOpcionesInterpretes();

        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";

        const modal = document.createElement("div");
        modal.className = "modal-content";

        modal.innerHTML = `
          <h3>Editar Evento</h3>
          <label for="lugar-select">Lugar:</label>
          <select id="lugar-select" size="5"></select>
          <label for="interprete-select">Intérprete(s):</label>
          <select id="interprete-select" multiple size="5"></select>
          <button id="guardar-btn">Guardar</button>
          <button id="cancelar-btn">Cancelar</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const { container: horaContainer, getHoraFinal } = crearBotonesHora();
        const { colorContainer } = crearColorPickers();

        const containerDiv = document.createElement("div");
        containerDiv.style.display = "flex";
        containerDiv.style.justifyContent = "space-between";
        containerDiv.appendChild(horaContainer);
        containerDiv.appendChild(colorContainer);

        const lugarLabel = modal.querySelector('label[for="lugar-select"]');
        modal.insertBefore(containerDiv, lugarLabel);

        const lugarSelect = modal.querySelector("#lugar-select");
        const interpreteSelect = modal.querySelector("#interprete-select");

        lugares.forEach((l) => {
          const option = document.createElement("option");
          option.value = l;
          option.textContent = l;
          lugarSelect.appendChild(option);
        });

        allInterpretes.forEach((i) => {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          interpreteSelect.appendChild(option);
        });

        lugarSelect.value = lugar || "";

        let [hSel, mSel] = ["08", "00"];
        if (hora && hora.includes(":")) {
          [hSel, mSel] = hora.split(":");
        }

        const allButtons = horaContainer.querySelectorAll("button");
        allButtons.forEach((b) => {
          if (b.textContent === hSel || b.textContent === mSel) {
            b.style.backgroundColor = "yellow";
            b.style.color = "#000";
          } else {
            b.style.backgroundColor = "#444";
            b.style.color = "#fff";
          }
        });

        let interpreteArray = [];
        if (Array.isArray(interprete)) {
          interpreteArray = interprete;
        } else if (typeof interprete === "string") {
          interpreteArray = [interprete];
        }

        Array.from(interpreteSelect.options).forEach((opt) => {
          if (interpreteArray.includes(opt.value)) {
            opt.selected = true;
          }
        });

        const guardarBtn = modal.querySelector("#guardar-btn");
        const cancelarBtn = modal.querySelector("#cancelar-btn");

        guardarBtn.addEventListener("click", async () => {
          const nuevaHora = getHoraFinal();
          const nuevoLugar = lugarSelect.value;
          if (!nuevoLugar) {
            alert("Debe seleccionar un lugar.");
            return;
          }
          const nuevosInterpretes = Array.from(
            interpreteSelect.selectedOptions
          ).map((opt) => opt.value);
          if (!nuevosInterpretes.length) {
            alert("Debe seleccionar al menos un intérprete.");
            return;
          }

          const fields = {
            fecha,
            hora: nuevaHora,
            lugar: nuevoLugar,
            interprete: nuevosInterpretes,
          };

          await saveToAirtable(recordId, fields);
          alert("Evento actualizado correctamente.");
          document.body.removeChild(overlay);
          location.reload();
        });

        cancelarBtn.addEventListener("click", () => {
          document.body.removeChild(overlay);
        });
      }

      /**
       * Guarda en Airtable
       */
      async function saveToAirtable(recordId, fields) {
        const url = recordId
          ? `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}`
          : `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;

        const method = recordId ? "PATCH" : "POST";
        const body = { fields };

        try {
          const response = await fetch(url, {
            method,
            headers: {
              Authorization: `Bearer ${AIRTABLE_TOKEN}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorDetails = await response.json();
            console.error("Error al guardar en Airtable:", errorDetails);
            throw new Error(
              `Error en la solicitud a Airtable: ${errorDetails.error.message}`
            );
          }

          const data = await response.json();
          console.log("Datos guardados correctamente:", data);
          return data;
        } catch (error) {
          console.error("Error al guardar en Airtable:", error);
          alert(
            "No se pudo guardar el evento. Verifica los datos y vuelve a intentarlo."
          );
        }
      }

      /**
       * Inicializa el calendario
       */
      document.addEventListener("DOMContentLoaded", () => {
        // 1) Calendario de Enero
        const eneCalendarGrid = document.querySelector(".calendar-grid-ene");
        createCalendarDays(eneCalendarGrid, 2025, 0);

        // 2) Calendario de Febrero (NUEVO)
        const febCalendarGrid = document.querySelector(".calendar-grid-feb");
        createCalendarDays(febCalendarGrid, 2025, 1);

        // Cargamos eventos (se mostrarán en ambos meses)
        loadEvents();

        // Botón de edición
        const editBtn = document.querySelector("#edit-btn");
        editBtn.addEventListener("click", () => {
          editMode = !editMode;
          if (editMode) {
            editBtn.textContent = "Editar (ON)";
          } else {
            editBtn.textContent = "Editar (OFF)";
          }
        });
        // Al inicio está en OFF
        editBtn.textContent = "Editar (OFF)";
      });
    </script>
  </body>
</html>
