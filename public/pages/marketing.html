<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Marketing</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #1a0f0a;
        color: #d4a574;
        margin: 0;
        padding: 10px;
        min-height: 100vh;
        box-sizing: border-box;
      }

      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        display: block;
        gap: 15px;
      }

      .month {
        width: 100%;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .month-header {
        margin-bottom: 15px;
        padding: 10px;
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
          url("https://hebbkx1anhila5yf.public.blob.vercel-storage.com/11-2024-9vRUE8b2vSmqweM2I7CJw1H9gdAt6k.png");
        background-size: cover;
        background-position: center;
        border-radius: 8px;
      }

      .month-header h2 {
        color: #ffd700;
        margin: 0;
        font-size: 1.8rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        text-align: center;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .weekday {
        text-align: center;
        padding: 6px;
        font-weight: bold;
        color: #ffd700;
        font-size: 1rem;
      }

      .day {
        background-color: rgba(62, 39, 35, 0.5);
        border: 1px solid #4a2f2a;
        padding: 6px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow-y: auto;
      }

      .day:hover {
        background-color: rgba(82, 49, 45, 0.7);
      }

      .day-number {
        text-align: center;
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 1rem;
      }

      .event {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 5px;
        font-size: 0.8rem;
        background-color: rgba(41, 27, 23, 0.9);
        border-radius: 4px;
        padding: 4px;
        color: #ffd700;
        cursor: pointer;
      }

      .event div {
        padding: 2px 4px;
        border-radius: 3px;
        text-align: center;
      }

      .event .numero-tarea {
        background-color: #5a382f;
      }

      .event .tarea {
        background-color: #71443b;
      }

      .add-event {
        background-color: rgba(82, 49, 45, 0.7);
        text-align: center;
        padding: 4px;
        border-radius: 4px;
        color: #ffd700;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="month">
        <div class="month-header">
          <h2>Enero 2025</h2>
        </div>
        <div class="calendar-grid">
          <div class="weekday">Lun</div>
          <div class="weekday">Mar</div>
          <div class="weekday">Mié</div>
          <div class="weekday">Jue</div>
          <div class="weekday">Vie</div>
          <div class="weekday">Sáb</div>
          <div class="weekday">Dom</div>
        </div>
      </div>
    </div>

    <script>
      const AIRTABLE_TOKEN =
        "patuKKtlyfqvVNCpc.25468d0bda6badcfd90c84a03a681fc462c0b66b57b964eddb0449b24134a45e";
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      const TABLE_NAME = "calendario-marketing";

      function createCalendarDays(calendarGrid, year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let startingDay = firstDay.getDay() - 1; // Ajustar para que inicie en lunes
        if (startingDay < 0) startingDay = 6;

        for (let i = 0; i < startingDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "day";
          calendarGrid.appendChild(emptyDay);
        }

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dayElement = document.createElement("div");
          dayElement.className = "day";

          const dayNumber = document.createElement("div");
          dayNumber.className = "day-number";
          dayNumber.textContent = day;

          const addTaskBlock = document.createElement("div");
          addTaskBlock.className = "add-event";
          addTaskBlock.textContent = "+ Agregar tarea";
          addTaskBlock.addEventListener("click", () =>
            promptNewTask(day, month, year)
          );

          dayElement.appendChild(dayNumber);
          dayElement.appendChild(addTaskBlock);
          calendarGrid.appendChild(dayElement);
        }
      }

      async function loadTasks() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?sort%5B0%5D%5Bfield%5D=fecha`,
            {
              headers: {
                Authorization: `Bearer ${AIRTABLE_TOKEN}`,
              },
            }
          );
          const data = await response.json();
          displayTasks(data.records);
        } catch (error) {
          console.error("Error al cargar tareas:", error);
        }
      }

      function displayTasks(records) {
        const days = document.querySelectorAll(".day");
        records.forEach(({ fields }) => {
          const { fecha, tarea, "número de tarea": numeroTarea } = fields;
          if (!fecha) return;

          const [year, month, day] = fecha.split("-").map(Number);
          const dayElement = Array.from(days).find(
            (d) => parseInt(d.querySelector(".day-number")?.textContent) === day
          );

          if (!dayElement) return;

          const taskElement = document.createElement("div");
          taskElement.className = "event";

          const numeroElement = document.createElement("div");
          numeroElement.className = "numero-tarea";
          numeroElement.textContent = numeroTarea;

          const tareaElement = document.createElement("div");
          tareaElement.className = "tarea";
          tareaElement.textContent = tarea;

          taskElement.appendChild(numeroElement);
          taskElement.appendChild(tareaElement);

          taskElement.addEventListener("click", () =>
            editTask(fecha, numeroTarea, tarea)
          );

          dayElement.appendChild(taskElement);
        });
      }

      async function promptNewTask(day, month, year) {
        const fecha = `${year}-${String(month + 1).padStart(2, "0")}-${String(
          day
        ).padStart(2, "0")}`;
        const numeroTarea = prompt("Ingrese el número de tarea:");
        const tarea = prompt("Ingrese la descripción de la tarea:");

        if (!numeroTarea || !tarea) {
          alert("Todos los campos son obligatorios.");
          return;
        }

        const fields = { fecha, "número de tarea": numeroTarea, tarea };
        await saveToAirtable(null, fields);
        alert("Tarea guardada correctamente.");
        location.reload();
      }

      async function editTask(fecha, numeroTarea, tarea) {
        const newNumeroTarea = prompt("Editar número de tarea:", numeroTarea);
        const newTarea = prompt("Editar descripción de la tarea:", tarea);

        if (!newNumeroTarea || !newTarea) {
          alert("Todos los campos son obligatorios.");
          return;
        }

        const fields = {
          fecha,
          "número de tarea": newNumeroTarea,
          tarea: newTarea,
        };
        await saveToAirtable(null, fields);
        alert("Tarea actualizada correctamente.");
        location.reload();
      }

      async function saveToAirtable(recordId, fields) {
        const url = recordId
          ? `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}`
          : `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;

        const method = recordId ? "PATCH" : "POST";

        try {
          const response = await fetch(url, {
            method,
            headers: {
              Authorization: `Bearer ${AIRTABLE_TOKEN}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ fields }),
          });

          if (!response.ok) {
            throw new Error("Error al guardar en Airtable");
          }
        } catch (error) {
          console.error("Error al guardar en Airtable:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const calendarGrid = document.querySelector(".calendar-grid");
        createCalendarDays(calendarGrid, 2025, 0);
        loadTasks();
      });
    </script>
  </body>
</html>
