<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Boletín Luna N°1 - 2025 Undertango Fondo de Inversión</title>
    <!-- Estilos Básicos -->
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
        font-size: 16px;
      }
      .container {
        width: 95%;
        max-width: 1080px;
        margin: auto;
        overflow: hidden;
        padding: 5px;
      }
      header {
        background: #333;
        color: #fff;
        padding: 15px 0;
        border-bottom: #77aaff 3px solid;
        text-align: center;
        position: relative;
      }
      header h1 {
        margin: 0;
        font-size: 1.7em;
        text-transform: uppercase;
      }
      .logo-luna {
        width: 60px;
        position: absolute;
        top: 10px;
        left: 10px;
      }
      .main {
        background: #fff;
        margin: 10px 0;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 20px;
      }
      .info-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .info-box > div {
        flex: 1 1 300px;
        text-align: center;
        margin: 5px;
      }
      .info-box h2 {
        margin: 5px 0;
        font-size: 1.2em;
      }
      .large-text {
        font-size: 1.4em;
        font-weight: bold;
      }
      .variation {
        font-weight: bold;
      }
      .green-text { color: #28a745; }
      .red-text { color: #dc3545; }
      .chart-container {
        position: relative;
        height: 400px; /* Ajusta la altura a tu gusto */
        margin: 20px 0;
      }
      .grid-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .grid-box > div {
        flex: 1 1 300px;
        margin: 5px;
      }
      .bold-text {
        font-weight: bold;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
      }
      table th, table td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
        text-align: left;
      }
      .distribution-section {
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      .distribution-section h2 {
        margin-top: 0;
      }
      .distribution-box {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
      }
      .distribution-client {
        flex: 1 1 250px;
        background: #eaeaea;
        padding: 10px;
        border-radius: 5px;
      }
      .distribution-client h3 {
        margin-top: 0;
        font-size: 1.1em;
        text-align: center;
      }
      .distribution-client ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .distribution-client ul li {
        margin: 4px 0;
      }
      @media(max-width: 600px) {
        .info-box, .grid-box, .distribution-box {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>

    <!-- Librerías de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <img class="logo-luna" src="https://cdn-icons-png.flaticon.com/512/3267/3267734.png" alt="Logo Luna"/>
      <h1>Boletín Luna N°1 - 2025 Undertango Fondo de Inversión</h1>
    </header>

    <div class="container">
      <div class="main">
        <!-- Sección de datos generales de la caja y variaciones -->
        <div class="info-box" id="infoBoxGeneral">
          <div>
            <h2>Caja Undertango (AR$)</h2>
            <p class="large-text" id="valorCajaUndertango">Cargando...</p>
          </div>
          <div>
            <h2>Fondo de Inversión (AR$)</h2>
            <p class="large-text" id="valorFondoInversion">Cargando...</p>
            <p>(Monto total a retribuir)</p>
          </div>
        </div>

        <!-- Sección Valor de la acción y retribución -->
        <div class="info-box">
          <div>
            <h2>Valor de la Acción</h2>
            <p class="large-text" id="valorAccion">Cargando...</p>
          </div>
          <div>
            <h2>Retribución por Acción</h2>
            <p class="large-text" id="retribucionPorAccion">Cargando...</p>
          </div>
        </div>

        <!-- Gráfico de evolución -->
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>

        <!-- Sección de tenedores, acciones, etc. -->
        <div class="grid-box">
          <div>
            <h3>Accionistas</h3>
            <!-- Tabla para visualizar inversores y sus datos -->
            <table id="tablaAccionistas">
              <thead>
                <tr>
                  <th>Inversor</th>
                  <th>Acciones</th>
                  <th>Capital (AR$)</th>
                  <th>Porcentaje</th>
                  <th>Retribución</th>
                </tr>
              </thead>
              <tbody id="listaAccionistas"></tbody>
            </table>
            <p class="bold-text" style="text-align:right;margin-top:5px;">
              Total Acciones: <span id="accionesTotales">...</span>
            </p>
          </div>
          <div>
            <h3>Variación Mensual (Caja Undertango)</h3>
            <p class="variation" id="variacionCajaUndertango"></p>
          </div>
        </div>
      </div>

      <!-- Sección adicional para porcentajes por cliente -->
      <div class="distribution-section">
        <h2>Distribución por Cliente</h2>
        <p>Estos son los porcentajes actuales definidos en el FD.I para cada cliente:</p>
        <div class="distribution-box">
          <!-- Cruceros -->
          <div class="distribution-client">
            <h3>Cruceros</h3>
            <ul>
              <li>10% Caja Undertango</li>
              <li>7% GO</li>
              <li>4% FDI</li>
              <li>32% Personal</li>
              <li>15% Bianca</li>
              <li>15% Pablo</li>
              <li>5% Producción</li>
              <li>5% Moda U</li>
              <li>3% Marketing</li>
              <li>4% Impuestos</li>
            </ul>
          </div>
          <!-- Casa Malbec -->
          <div class="distribution-client">
            <h3>Casa Malbec</h3>
            <ul>
              <li>36% Personal</li>
              <li>14% Bianca</li>
              <li>14% Pablo</li>
              <li>10% Caja Undertango</li>
              <li>5% GO</li>
              <li>3% FDI</li>
              <li>5% Producción</li>
              <li>5% Moda U</li>
              <li>3% Marketing</li>
              <li>4% Impuestos</li>
            </ul>
          </div>
          <!-- Meliá -->
          <div class="distribution-client">
            <h3>Meliá</h3>
            <ul>
              <li>20% Bianca</li>
              <li>5% FDI</li>
              <li>20% Caja Undertango</li>
              <li>20% Pablo</li>
              <li>12% GO</li>
              <li>10% Producción</li>
              <li>6% Moda U</li>
              <li>3% Marketing</li>
              <li>4% Impuestos</li>
            </ul>
          </div>
          <!-- DAM -->
          <div class="distribution-client">
            <h3>DAM</h3>
            <ul>
              <li>100% Producción</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript principal -->
    <script>
      // Ajusta estos tokens / IDs a tu base
      const AIRTABLE_API_KEY = "pato81fvPnkEuWh3z.106e22ccb41bfad6205fed18c2ac2e509a026e20071c0420b94e3dd1da5d7764";
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      const TABLE_MOVIMIENTOS = "fdi1";  
      const TABLE_INVERSORES = "fdi";   

      let cajaUndertango = 0;
      let fondoInversion = 0;
      let accionistas = [];
      let totalAcciones = 0;
      let historicoCaja = [];

      document.addEventListener("DOMContentLoaded", async () => {
        await fetchMovimientos();    // Suma Caja Undertango y Fondo de Inversion
        await fetchInversores();    // Lista de inversores y sus acciones
        calcularTotales();          // Sumar acciones
        renderDatos();              // Mostrar en HTML
        dibujarGrafico();           // Gráfico
      });

      // [1] Obtener datos desde fdi1
      async function fetchMovimientos() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_MOVIMIENTOS}`,
            {
              headers: {
                Authorization: `Bearer ${AIRTABLE_API_KEY}`
              }
            }
          );
          if (!response.ok) {
            throw new Error("Error al obtener datos de Airtable - fdi1");
          }
          const data = await response.json();

          cajaUndertango = 0;
          fondoInversion = 0;
          historicoCaja = [];

          data.records.forEach(record => {
            const f = record.fields;
            if (f["Caja Undertango"] !== undefined) {
              cajaUndertango += parseFloat(f["Caja Undertango"] || 0);
            }
            if (f["Fondo de Inversion"] !== undefined) {
              fondoInversion += parseFloat(f["Fondo de Inversion"] || 0);
            }
            if (f["Fecha"] && f["Caja Undertango"] !== undefined) {
              const fechaObj = new Date(f["Fecha"]);
              const mesAnio = fechaObj.toLocaleDateString("es-AR", {
                month: "long",
                year: "numeric"
              });
              historicoCaja.push({
                mes: mesAnio,
                valor: parseFloat(f["Caja Undertango"] || 0)
              });
            }
          });
        } catch (error) {
          console.error("fetchMovimientos:", error);
        }
      }

      // [2] Obtener datos desde fdi (inversores)
      async function fetchInversores() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_INVERSORES}`,
            {
              headers: {
                Authorization: `Bearer ${AIRTABLE_API_KEY}`
              }
            }
          );
          if (!response.ok) {
            throw new Error("Error al obtener datos de inversores - tabla fdi");
          }
          const data = await response.json();

          accionistas = data.records
            .filter(record => record.fields["Inversor"] && record.fields["cantidad de acciones"])
            .map(record => ({
              nombre: record.fields["Inversor"],
              acciones: parseInt(record.fields["cantidad de acciones"], 10) || 0
            }));
        } catch (error) {
          console.error("fetchInversores:", error);
        }
      }

      // [3] Calcular totales
      function calcularTotales() {
        totalAcciones = accionistas.reduce((acum, inv) => acum + inv.acciones, 0);
      }

      // [4] Renderizar datos
      function renderDatos() {
        // Caja Undertango
        document.getElementById("valorCajaUndertango").textContent = formatMoney(cajaUndertango);

        // Fondo de Inversión
        document.getElementById("valorFondoInversion").textContent = formatMoney(fondoInversion);

        // Valor de la Acción = Caja Undertango / totalAcciones (opcional)
        let valorAccion = 0;
        if (totalAcciones > 0) {
          valorAccion = cajaUndertango / totalAcciones;
        }
        document.getElementById("valorAccion").textContent = formatMoney(valorAccion);

        // Retribución por Acción = Fondo de Inversion / totalAcciones
        let retribPorAccion = 0;
        if (totalAcciones > 0) {
          retribPorAccion = fondoInversion / totalAcciones;
        }
        document.getElementById("retribucionPorAccion").textContent = formatMoney(retribPorAccion);

        // Mostrar inversores en la tabla
        const tbody = document.getElementById("listaAccionistas");
        tbody.innerHTML = "";

        accionistas.forEach(a => {
          const capitalAcumulado = a.acciones * valorAccion;
          const porcentajeAcciones = (a.acciones / totalAcciones) * 100;
          const retribDelAccionista = a.acciones * retribPorAccion;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.nombre}</td>
            <td>${a.acciones}</td>
            <td>${formatMoney(capitalAcumulado)}</td>
            <td>${porcentajeAcciones.toFixed(2)}%</td>
            <td>${formatMoney(retribDelAccionista)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Total Acciones
        document.getElementById("accionesTotales").textContent = totalAcciones.toString();

        // Variación Mensual
        historicoCaja.sort((a, b) => ordenarPorMesAnio(a.mes, b.mes));
        if (historicoCaja.length > 1) {
          const penultimo = historicoCaja[historicoCaja.length - 2].valor || 1;
          const ultimo = historicoCaja[historicoCaja.length - 1].valor || 1;
          const variacion = ((ultimo - penultimo) / penultimo) * 100;
          showVariation(variacion, "variacionCajaUndertango");
        } else {
          document.getElementById("variacionCajaUndertango").textContent = "Sin datos previos";
        }
      }

      // [5] Dibujar gráfico con Chart.js
      function dibujarGrafico() {
        const ctx = document.getElementById("chartEvolucion").getContext("2d");
        historicoCaja.sort((a, b) => ordenarPorMesAnio(a.mes, b.mes));

        const labels = historicoCaja.map(item => item.mes);
        const dataValues = historicoCaja.map(item => item.valor);

        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Evolución Caja Undertango",
                data: dataValues,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function(value) {
                    return formatMoney(value);
                  }
                }
              }
            }
          }
        });
      }

      // Helpers
      function formatMoney(num) {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
          maximumFractionDigits: 2
        }).format(num || 0);
      }

      function showVariation(variacion, elementoId) {
        const spanVar = document.getElementById(elementoId);
        const vPorc = variacion.toFixed(2) + "%";
        if (variacion >= 0) {
          spanVar.textContent = `Var: +${vPorc}`;
          spanVar.classList.add("green-text");
        } else {
          spanVar.textContent = `Var: ${vPorc}`;
          spanVar.classList.add("red-text");
        }
      }

      // Ordenar por mes y año
      function ordenarPorMesAnio(m1, m2) {
        const meses = [
          "enero","febrero","marzo","abril","mayo","junio",
          "julio","agosto","septiembre","octubre","noviembre","diciembre"
        ];
        function parseMesAnio(str) {
          let lower = str.toLowerCase().trim();
          // Intentamos dividir por " de "
          let parts = lower.split("de").map(s => s.trim());
          if (parts.length < 2) {
            // sino, dividimos por espacio
            parts = lower.split(" ");
          }
          const mesStr = parts[0];
          const anioStr = parts[1] ? parts[1] : "2025";
          const mesNum = meses.indexOf(mesStr);
          const anioNum = parseInt(anioStr, 10) || 2025;
          return { mesNum, anioNum };
        }
        const { mesNum: mNum1, anioNum: aNum1 } = parseMesAnio(m1);
        const { mesNum: mNum2, anioNum: aNum2 } = parseMesAnio(m2);
        if (aNum1 !== aNum2) {
          return aNum1 - aNum2;
        }
        return mNum1 - mNum2;
      }
    </script>
  </body>
</html>
