<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Boletín Luna N°1 - 2025 Undertango Fondo de Inversión</title>

    <!-- Estilos Básicos -->
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
        font-size: 16px;
      }
      .container {
        width: 95%;
        max-width: 1080px;
        margin: auto;
        overflow: hidden;
        padding: 5px;
      }
      header {
        background: #333;
        color: #fff;
        padding: 15px 0;
        border-bottom: #77aaff 3px solid;
        text-align: center;
        position: relative;
      }
      header h1 {
        margin: 0;
        font-size: 1.7em;
        text-transform: uppercase;
      }
      .logo-luna {
        width: 60px;
        position: absolute;
        top: 10px;
        left: 10px;
      }
      .main {
        background: #fff;
        margin: 10px 0;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 20px;
      }
      .info-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .info-box > div {
        flex: 1 1 300px;
        text-align: center;
        margin: 5px;
      }
      .info-box h2 {
        margin: 5px 0;
        font-size: 1.2em;
      }
      .large-text {
        font-size: 1.4em;
        font-weight: bold;
      }
      .variation {
        font-weight: bold;
      }
      .green-text { color: #28a745; }
      .red-text { color: #dc3545; }
      .chart-container {
        position: relative;
        height: 400px; /* Ajusta la altura a tu gusto */
        margin: 20px 0;
      }
      .grid-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .grid-box > div {
        flex: 1 1 300px;
        margin: 5px;
      }
      .bold-text {
        font-weight: bold;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
      }
      table th, table td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
        text-align: left;
      }
      .distribution-section {
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      .distribution-section h2 {
        margin-top: 0;
      }
      .distribution-box {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
      }
      .distribution-client {
        flex: 1 1 250px;
        background: #eaeaea;
        padding: 10px;
        border-radius: 5px;
      }
      .distribution-client h3 {
        margin-top: 0;
        font-size: 1.1em;
        text-align: center;
      }
      .distribution-client ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .distribution-client ul li {
        margin: 4px 0;
      }

      /* Estilos para la sección de registro de movimientos (fdi2) */
      .movimientos-section {
        background: #fff;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 15px;
      }
      .movimientos-section h2 {
        margin-top: 0;
      }
      .registro-form {
        margin-top: 20px;
        padding: 15px;
        background: #fdfdfd;
        border-radius: 5px;
      }
      .registro-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .registro-form input,
      .registro-form select,
      .registro-form button {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      .registro-form button {
        background: #333;
        color: #fff;
        cursor: pointer;
      }
      .registro-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .registro-table th, .registro-table td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
      }
      .registro-table th {
        background: #f4f4f4;
      }

      @media(max-width: 600px) {
        .info-box, .grid-box, .distribution-box {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>

    <!-- Librerías de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <header>
      <img class="logo-luna" src="https://cdn-icons-png.flaticon.com/512/3267/3267734.png" alt="Logo Luna"/>
      <h1>Boletín Luna N°1 - 2025 Undertango Fondo de Inversión</h1>
    </header>

    <div class="container">
      <div class="main">
        <!-- Sección de datos generales de la caja y variaciones -->
        <div class="info-box" id="infoBoxGeneral">
          <div>
            <h2>Caja Undertango (AR$)</h2>
            <p class="large-text" id="valorCajaUndertango">Cargando...</p>
          </div>
          <div>
            <h2>Fondo de Inversión (AR$)</h2>
            <p class="large-text" id="valorFondoInversion">Cargando...</p>
            <p>(Monto total a retribuir)</p>
          </div>
        </div>

        <!-- Sección Valor de la acción y retribución -->
        <div class="info-box">
          <div>
            <h2>Valor de la Acción</h2>
            <p class="large-text" id="valorAccion">Cargando...</p>
          </div>
          <div>
            <h2>Retribución por Acción</h2>
            <p class="large-text" id="retribucionPorAccion">Cargando...</p>
          </div>
        </div>

        <!-- Gráfico de evolución -->
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>

        <!-- Sección de tenedores, acciones, etc. -->
        <div class="grid-box">
          <div>
            <h3>Accionistas</h3>
            <!-- Tabla para visualizar inversores y sus datos -->
            <table id="tablaAccionistas">
              <thead>
                <tr>
                  <th>Inversor</th>
                  <th>Acciones</th>
                  <th>Capital (AR$)</th>
                  <th>Porcentaje</th>
                  <th>Retribución</th>
                </tr>
              </thead>
              <tbody id="listaAccionistas"></tbody>
            </table>
            <p class="bold-text" style="text-align:right;margin-top:5px;">
              Total Acciones: <span id="accionesTotales">...</span>
            </p>
          </div>
          <div>
            <h3>Variación Mensual (Caja Undertango)</h3>
            <p class="variation" id="variacionCajaUndertango"></p>
          </div>
        </div>
      </div>

      <!-- Sección adicional para porcentajes por cliente -->
      <div class="distribution-section">
        <h2>Distribución por Cliente</h2>
        <p>Estos son los porcentajes actuales definidos en el FD.I para cada cliente:</p>
        <div class="distribution-box">
          <!-- Tu configuración de clientes -->
          <!-- ... -->
        </div>
      </div>

      <!-- Sección de Movimientos del Fondo (tabla fdi2) -->
      <div class="movimientos-section">
        <h2>Registro de Movimientos (Fondo de Inversión)</h2>
        <!-- Tabla de movimientos fdi2 -->
        <table class="registro-table" id="tablaMovimientosFDI2">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Inversor</th>
              <th>Descripción</th>
              <th>Acción</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody id="listaMovimientosFDI2"></tbody>
        </table>

        <!-- Formulario para agregar un nuevo movimiento en fdi2 -->
        <div class="registro-form">
          <h3>Agregar Movimiento en FDI2</h3>

          <label for="fechaFDI2">Fecha</label>
          <input type="date" id="fechaFDI2" />

          <label for="inversorFDI2">Inversor</label>
          <select id="inversorFDI2">
            <option value="">--Seleccione--</option>
            <option value="Bianca Wagner">Bianca Wagner</option>
            <option value="Luciano Valdemarín">Luciano Valdemarín</option>
            <option value="Pablo Cieslik">Pablo Cieslik</option>
          </select>

          <label for="descripcionFDI2">Descripción</label>
          <input type="text" id="descripcionFDI2" placeholder="Ej: Retiro de retribución" />

          <label for="accionFDI2">Acción</label>
          <select id="accionFDI2">
            <option value="">--Seleccione--</option>
            <option value="compra acciones">Compra Acciones</option>
            <option value="vende acciones">Vende Acciones</option>
            <option value="recibe retribución">Recibe Retribución</option>
          </select>

          <label for="cantidadFDI2">Monto o Cantidad</label>
          <input type="number" id="cantidadFDI2" step="0.01" />

          <button id="btnAgregarFDI2">Agregar Movimiento</button>
        </div>
      </div>
    </div>

    <!-- JavaScript principal -->
    <script>
      // Ajusta estos tokens / IDs a tu base de Airtable
      const AIRTABLE_API_KEY = "patuKKtlyfqvVNCpc.25468d0bda6badcfd90c84a03a681fc462c0b66b57b964eddb0449b24134a45e";
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      // Nombres de tablas en Airtable
      const TABLE_MOVIMIENTOS = "fdi1";
      const TABLE_INVERSORES = "fdi";
      const TABLE_FONDO = "fdi2";

      // Variables globales
      let cajaUndertango = 0;
      let fondoInversion = 0;
      let accionistas = [];
      let totalAcciones = 0;
      let historicoCaja = [];

      document.addEventListener("DOMContentLoaded", async () => {
        await fetchMovimientos();   // Cargar fdi1
        await fetchInversores();    // Cargar fdi
        calcularTotales();
        renderDatos();
        dibujarGrafico();

        // Cargar movimientos fdi2
        await fetchMovimientosFDI2();
      });

      // [1] Obtener datos desde fdi1
      async function fetchMovimientos() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_MOVIMIENTOS}`;
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${AIRTABLE_API_KEY}`
            }
          });
          if (!response.ok) {
            throw new Error("Error al obtener datos de Airtable - fdi1");
          }
          const data = await response.json();

          cajaUndertango = 0;
          fondoInversion = 0;
          historicoCaja = [];

          data.records.forEach(record => {
            const f = record.fields;
            // Sumamos Caja Undertango
            if (f["Caja Undertango"] !== undefined) {
              cajaUndertango += parseFloat(f["Caja Undertango"] || 0);
            }
            // Sumamos Fondo de Inversion
            if (f["Fondo de Inversion"] !== undefined) {
              fondoInversion += parseFloat(f["Fondo de Inversion"] || 0);
            }
            // Histórico para variación
            if (f["Fecha"] && f["Caja Undertango"] !== undefined) {
              const fechaObj = new Date(f["Fecha"]);
              const mesAnio = fechaObj.toLocaleDateString("es-AR", {
                month: "long",
                year: "numeric"
              });
              historicoCaja.push({
                mes: mesAnio,
                valor: parseFloat(f["Caja Undertango"] || 0)
              });
            }
          });
        } catch (error) {
          console.error("fetchMovimientos:", error);
        }
      }

      // [2] fdi (inversores)
      async function fetchInversores() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_INVERSORES}`;
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${AIRTABLE_API_KEY}`
            }
          });
          if (!response.ok) {
            throw new Error("Error al obtener datos de inversores - fdi");
          }
          const data = await response.json();

          accionistas = data.records
            .filter(r => r.fields["Inversor"] && r.fields["cantidad de acciones"])
            .map(r => ({
              id: r.id,
              nombre: r.fields["Inversor"],
              acciones: parseFloat(r.fields["cantidad de acciones"]) || 0
            }));
        } catch (error) {
          console.error("fetchInversores:", error);
        }
      }

      // [3] Calcular totales
      function calcularTotales() {
        totalAcciones = accionistas.reduce((acc, inv) => acc + inv.acciones, 0);
      }

      // [4] Renderizar
      function renderDatos() {
        document.getElementById("valorCajaUndertango").textContent = formatMoney(cajaUndertango);
        document.getElementById("valorFondoInversion").textContent = formatMoney(fondoInversion);

        let valorAccion = 0;
        if (totalAcciones > 0) {
          valorAccion = cajaUndertango / totalAcciones;
        }
        document.getElementById("valorAccion").textContent = formatMoney(valorAccion);

        let retribPorAccion = 0;
        if (totalAcciones > 0) {
          retribPorAccion = fondoInversion / totalAcciones;
        }
        document.getElementById("retribucionPorAccion").textContent = formatMoney(retribPorAccion);

        const tbody = document.getElementById("listaAccionistas");
        tbody.innerHTML = "";

        accionistas.forEach(a => {
          const capitalAcumulado = a.acciones * valorAccion;
          const porcentajeAcciones = (a.acciones / totalAcciones) * 100;
          const retribDelAccionista = a.acciones * retribPorAccion;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.nombre}</td>
            <td>${a.acciones.toFixed(2)}</td>
            <td>${formatMoney(capitalAcumulado)}</td>
            <td>${porcentajeAcciones.toFixed(2)}%</td>
            <td>${formatMoney(retribDelAccionista)}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("accionesTotales").textContent = totalAcciones.toFixed(2);

        historicoCaja.sort((a, b) => ordenarPorMesAnio(a.mes, b.mes));
        if (historicoCaja.length > 1) {
          const penultimo = historicoCaja[historicoCaja.length - 2].valor || 1;
          const ultimo = historicoCaja[historicoCaja.length - 1].valor || 1;
          const variacion = ((ultimo - penultimo) / penultimo) * 100;
          showVariation(variacion, "variacionCajaUndertango");
        } else {
          document.getElementById("variacionCajaUndertango").textContent = "Sin datos previos";
        }
      }

      // [5] Gráfico
      function dibujarGrafico() {
        const ctx = document.getElementById("chartEvolucion").getContext("2d");
        historicoCaja.sort((a, b) => ordenarPorMesAnio(a.mes, b.mes));

        const labels = historicoCaja.map(item => item.mes);
        const dataValues = historicoCaja.map(item => item.valor);

        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Evolución Caja Undertango",
                data: dataValues,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function(value) {
                    return formatMoney(value);
                  }
                }
              }
            }
          }
        });
      }

      // ============================================
      // Movimientos en fdi2 (con el campo "fecha")
      // ============================================
      async function fetchMovimientosFDI2() {
        try {
          // Cambiamos "Fecha" a "fecha" en el parámetro de sort
          const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_FONDO}?sort[0][field]=fecha&sort[0][direction]=desc`;
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${AIRTABLE_API_KEY}`
            }
          });
          if (!response.ok) {
            throw new Error("Error al obtener datos de Airtable - fdi2");
          }
          const data = await response.json();
          renderMovimientosFDI2(data.records);
        } catch (error) {
          console.error("fetchMovimientosFDI2:", error);
        }
      }

      function renderMovimientosFDI2(records) {
        const tbody = document.getElementById("listaMovimientosFDI2");
        tbody.innerHTML = "";

        records.forEach(rec => {
          const f = rec.fields;
          // Cambiamos f["Fecha"] por f["fecha"]
          const fechaVal = f["fecha"] ? new Date(f["fecha"]).toLocaleDateString() : "";
          const inversor = f["Inversor"] || "";
          const descripcion = f["descripcion"] || "";
          const accion = f["Acción"] || "";
          const cantidad = f["cantidad"] || 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fechaVal}</td>
            <td>${inversor}</td>
            <td>${descripcion}</td>
            <td>${accion}</td>
            <td>${cantidad}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("btnAgregarFDI2").addEventListener("click", async () => {
        const fecha = document.getElementById("fechaFDI2").value;
        const inversor = document.getElementById("inversorFDI2").value; 
        const descripcion = document.getElementById("descripcionFDI2").value.trim();
        const accion = document.getElementById("accionFDI2").value;
        const montoOCantidad = parseFloat(document.getElementById("cantidadFDI2").value) || 0;

        if (!fecha || !accion) {
          alert("Por favor, completa al menos la fecha y la acción.");
          return;
        }

        try {
          // Enviamos a fdi2 con el campo "fecha" (minúsculas)
          await createRecordFDI2({ 
            fecha: fecha,           // <--- "fecha", no "Fecha"
            Inversor: inversor,
            descripcion: descripcion,
            "Acción": accion,       // si tu campo en Airtable se llama "Acción" con tilde, déjalo así
            cantidad: montoOCantidad
          });

          if (accion === "recibe retribución") {
            await createRecordFDI1({
              Fecha: fecha,
              Origen: "FDI",
              Destino: "Retribución",
              Detalle: descripcion || "Retribución",
              Monto: -montoOCantidad,
              "Fondo de Inversion": -montoOCantidad
            });
          }

          if (accion === "compra acciones") {
            await createRecordFDI1({
              Fecha: fecha,
              Origen: "FDI",
              Destino: "Compra Acciones",
              Detalle: descripcion,
              Monto: -montoOCantidad,
              "Fondo de Inversion": -montoOCantidad
            });

            // Calculamos cuántas acciones compra
            const valorAccion = (totalAcciones > 0) ? (cajaUndertango / totalAcciones) : 1;
            const accionesCompradas = montoOCantidad / valorAccion;

            const inversorObj = accionistas.find(a => a.nombre === inversor);
            if (inversorObj) {
              const nuevasAcciones = inversorObj.acciones + accionesCompradas;
              await updateAccionesInversor(inversorObj.id, nuevasAcciones);
            }
          }

          /*
          if (accion === "vende acciones") {
            // Ejemplo (adaptar si lo necesitas):
            await createRecordFDI1({
              Fecha: fecha,
              Origen: "Venta Acciones",
              Destino: "Fondo de Inversion",
              Detalle: descripcion,
              Monto: montoOCantidad,
              "Fondo de Inversion": montoOCantidad
            });
            const valorAccion = (totalAcciones > 0) ? (cajaUndertango / totalAcciones) : 1;
            const accionesVendidas = montoOCantidad / valorAccion;
            const inversorObj = accionistas.find(a => a.nombre === inversor);
            if (inversorObj && inversorObj.acciones >= accionesVendidas) {
              const nuevasAcciones = inversorObj.acciones - accionesVendidas;
              await updateAccionesInversor(inversorObj.id, nuevasAcciones);
            }
          }
          */

          // Recargamos todo
          await fetchMovimientosFDI2();
          await fetchMovimientos();
          await fetchInversores();
          calcularTotales();
          renderDatos();

          // Limpiamos formulario
          document.getElementById("fechaFDI2").value = "";
          document.getElementById("inversorFDI2").value = "";
          document.getElementById("descripcionFDI2").value = "";
          document.getElementById("accionFDI2").value = "";
          document.getElementById("cantidadFDI2").value = "";

          alert("Movimiento agregado correctamente.");
        } catch (error) {
          console.error("Error al agregar movimiento fdi2:", error);
          alert("Ocurrió un error al agregar el movimiento en fdi2.");
        }
      });

      async function createRecordFDI2(fields) {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_FONDO}`;
        
        // Format fields - ahora Inversor es un string simple para Single Select
        const formattedFields = {
          fecha: fields.fecha,
          Inversor: fields.Inversor,
          "Acción": fields.Acción,
          cantidad: fields.cantidad,
          Detalle: fields.descripcion // <= si en el formulario la variable se llama 'descripcion'
        };
        
      
        console.log('Formatted fields:', formattedFields);
      
        const response = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${AIRTABLE_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            records: [{ fields: formattedFields }]
          })
        });
      
        if (!response.ok) {
          const errorData = await response.json();
          console.error("Request payload:", { fields: formattedFields });
          console.error("Airtable error response:", errorData);
          throw new Error(`No se pudo crear el registro en fdi2: ${errorData.error?.message || 'Error desconocido'}`);
        }
      
        return await response.json();
      }
      async function createRecordFDI1(fields) {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_MOVIMIENTOS}`;
        const response = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${AIRTABLE_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            records: [{ fields }]
          })
        });
        if (!response.ok) {
          const errorData = await response.json();
          console.error("Error createRecordFDI1:", errorData);
          throw new Error("No se pudo crear el registro en fdi1");
        }
      }

      async function updateAccionesInversor(recordId, nuevasAcciones) {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_INVERSORES}`;
        const response = await fetch(url, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${AIRTABLE_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            records: [
              {
                id: recordId,
                fields: {
                  "cantidad de acciones": nuevasAcciones
                }
              }
            ]
          })
        });
        if (!response.ok) {
          const errorData = await response.json();
          console.error("Error updateAccionesInversor:", errorData);
          throw new Error("No se pudo actualizar la cantidad de acciones en fdi");
        }
      }

      // Helpers
      function formatMoney(num) {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
          maximumFractionDigits: 2
        }).format(num || 0);
      }

      function showVariation(variacion, elementoId) {
        const spanVar = document.getElementById(elementoId);
        const vPorc = variacion.toFixed(2) + "%";
        if (variacion >= 0) {
          spanVar.textContent = `Var: +${vPorc}`;
          spanVar.classList.add("green-text");
        } else {
          spanVar.textContent = `Var: ${vPorc}`;
          spanVar.classList.add("red-text");
        }
      }

      function ordenarPorMesAnio(m1, m2) {
        const meses = [
          "enero","febrero","marzo","abril","mayo","junio",
          "julio","agosto","septiembre","octubre","noviembre","diciembre"
        ];
        function parseMesAnio(str) {
          let lower = str.toLowerCase().trim();
          let parts = lower.split("de").map(s => s.trim());
          if (parts.length < 2) {
            parts = lower.split(" ");
          }
          const mesStr = parts[0];
          const anioStr = parts[1] ? parts[1] : "2025";
          const mesNum = meses.indexOf(mesStr);
          const anioNum = parseInt(anioStr, 10) || 2025;
          return { mesNum, anioNum };
        }
        const { mesNum: mNum1, anioNum: aNum1 } = parseMesAnio(m1);
        const { mesNum: mNum2, anioNum: aNum2 } = parseMesAnio(m2);
        if (aNum1 !== aNum2) {
          return aNum1 - aNum2;
        }
        return mNum1 - mNum2;
      }
    </script>

  </body>
</html>
