<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor Financiero</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
      }
      form {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        margin-top: 10px;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .button-container {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      .error-message,
      .success-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        display: none;
      }
      .error-message {
        color: #dc3545;
        border: 1px solid #dc3545;
      }
      .success-message {
        color: #28a745;
        border: 1px solid #28a745;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Gestor Financiero</h1>
      <div>
        <label for="cajaNeta">Caja Neta:</label>
        <input type="text" id="cajaNeta" value="0.00" readonly />
      </div>
    </div>

    <form id="registroForm">
      <h2>Agregar Nuevo Registro</h2>
      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" required />

      <label for="tipo">Tipo:</label>
      <select id="tipo" required>
        <option value="Ingreso">Ingreso</option>
        <option value="Egreso">Egreso</option>
      </select>

      <label for="naturaleza">Naturaleza:</label>
      <input type="text" id="naturaleza" required />

      <label for="beneficiario">Beneficiario:</label>
      <input type="text" id="beneficiario" required />

      <label for="detalle">Detalle:</label>
      <input type="text" id="detalle" required />

      <label for="monto">Monto:</label>
      <input type="number" id="monto" step="0.01" required />

      <div class="button-container">
        <button type="submit">Agregar Registro</button>
        <button type="button" id="distribuirBtn">Distribuir</button>
      </div>
    </form>

    <div id="errorMessage" class="error-message"></div>
    <div id="successMessage" class="success-message"></div>

    <table id="registrosTable">
      <thead>
        <tr>
          <th>ID Fecha</th>
          <th>Tipo</th>
          <th>Naturaleza</th>
          <th>Beneficiario</th>
          <th>Detalle</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="distribucionModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Distribución de Ingresos</h2>
        <div id="distribucionDetalle"></div>
      </div>
    </div>

    <script>
      const AIRTABLE_API_KEY =
        "pato81fvPnkEuWh3z.106e22ccb41bfad6205fed18c2ac2e509a026e20071c0420b94e3dd1da5d7764";
      const BASE_ID = "appPGVN4sDJ0aTrSb";
      const TABLE_NAME = "fdi1";

      async function fetchRecords() {
        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`,
            {
              headers: {
                Authorization: `Bearer ${AIRTABLE_API_KEY}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          displayRecords(data.records);
          updateCajaNeta(data.records);
        } catch (error) {
          showError(`Error al cargar los datos: ${error.message}`);
          console.error("Error completo:", error);
        }
      }

      function displayRecords(records) {
        const tbody = document.querySelector("#registrosTable tbody");
        tbody.innerHTML = "";

        records.forEach((record) => {
          const row = tbody.insertRow();
          const fields = record.fields;

          // Asegúrate de que el campo "fechaid" coincida exactamente con el nombre de Airtable
          row.innerHTML = `
            <td>${fields["fechaid"] || ""}</td>
            <td>${fields["Tipo"] || ""}</td>
            <td>${fields["Naturaleza"] || ""}</td>
            <td>${fields["Beneficiario"] || ""}</td>
            <td>${fields["Detalle"] || ""}</td>
            <td>${formatCurrency(fields["Monto"] || 0)}</td>
          `;
        });
      }

      function updateCajaNeta(records) {
        const total = records.reduce((sum, record) => {
          const monto = parseFloat(record.fields.Monto) || 0;
          return sum + (record.fields.Tipo === "Ingreso" ? monto : -monto);
        }, 0);

        document.getElementById("cajaNeta").value = total.toFixed(2);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(amount);
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        console.error(message);
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 10000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMessage");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 5000);
      }

      async function addRecord(event) {
        event.preventDefault();
        const fecha = document.getElementById("fecha").value;
        const tipo = document.getElementById("tipo").value;
        const naturaleza = document.getElementById("naturaleza").value;
        const beneficiario = document.getElementById("beneficiario").value;
        const detalle = document.getElementById("detalle").value;
        const monto = parseFloat(document.getElementById("monto").value);

        if (
          !fecha ||
          !tipo ||
          !naturaleza ||
          !beneficiario ||
          !detalle ||
          isNaN(monto)
        ) {
          showError(
            "Todos los campos son obligatorios y el monto debe ser un número válido."
          );
          return;
        }

        // Verificar que el valor de "tipo" sea válido (solo puede ser "Ingreso" o "Egreso")
        if (tipo !== "Ingreso" && tipo !== "Egreso") {
          showError("El valor del campo 'Tipo' debe ser 'Ingreso' o 'Egreso'.");
          return;
        }

        const newRecord = {
          records: [
            {
              fields: {
                fechaid: fecha,
                Tipo: tipo,
                Naturaleza: naturaleza,
                Beneficiario: beneficiario,
                Detalle: detalle,
                Monto: monto,
              },
            },
          ],
        };

        console.log(
          "Enviando el siguiente registro:",
          JSON.stringify(newRecord, null, 2)
        );

        try {
          const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${AIRTABLE_API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newRecord),
            }
          );

          const responseData = await response.json();
          console.log(
            "Datos de la respuesta:",
            JSON.stringify(responseData, null, 2)
          );

          if (!response.ok) {
            throw new Error(
              `HTTP error! status: ${
                response.status
              }, message: ${JSON.stringify(responseData)}`
            );
          }

          showSuccess("Registro agregado exitosamente");
          document.getElementById("registroForm").reset();
          fetchRecords();
        } catch (error) {
          showError(`Error al agregar el registro: ${error.message}`);
          console.error("Error completo:", error);
        }
      }

      document
        .getElementById("registroForm")
        .addEventListener("submit", addRecord);

      document.addEventListener("DOMContentLoaded", fetchRecords);

      // Modal close functionality
      const modal = document.getElementById("distribucionModal");
      const span = document.getElementsByClassName("close")[0];
      span.onclick = function () {
        modal.style.display = "none";
      };
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // Refresh every 5 minutes
      setInterval(fetchRecords, 300000);
    </script>
  </body>
</html>
