<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor Financiero</title>
    <link rel="icon" type="image/png" href="gestor-favicon.png" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        flex-wrap: nowrap;
      }
      .left-panel,
      .middle-panel,
      .right-panel {
        flex: 1;
        min-width: 300px;
        padding: 10px;
      }
      .left-panel {
        border-right: 1px solid #ccc;
      }
      .middle-panel {
        border-right: 1px solid #ccc;
      }
      .balance-box {
        background-color: #f5f5f5;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      .category-input,
      .name-input,
      .date-input,
      .amount-input,
      .net-balance,
      .month-panel {
        margin-bottom: 10px;
      }
      .record {
        background-color: #f9f9f9;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      .completed {
        text-decoration: line-through;
      }
      button {
        cursor: pointer;
        margin-right: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background-color: #fff;
      }
      button:hover {
        background-color: #f0f0f0;
      }
      .chart-container {
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
      }
      .small-chart-container {
        width: 100%;
        max-width: 200px;
        margin-top: 20px;
        display: inline-block;
      }
      input[type="number"] {
        width: 150px;
        padding: 5px;
        margin-right: 10px;
      }
      label {
        display: inline-block;
        width: 200px;
        margin-right: 10px;
      }
      .category-management {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .category-management h3 {
        margin-top: 0;
      }
      .category-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }
      .button-group {
        margin-bottom: 20px;
      }
      /* Estilos para modales */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 5px;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      /* Estilos para el contenedor de gráficos React */
      .charts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .chart-wrapper {
        flex: 1 1 400px;
      }
      .small-chart-wrapper {
        flex: 1 1 200px;
      }
    </style>
    <!-- Inclusión de React, ReactDOM, Babel y Chart.js desde CDNs -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>Gestor Financiero</h1>

    <div class="container">
      <!-- Panel Izquierdo -->
      <div class="left-panel">
        <div class="balance-box">
          <div class="net-balance">
            <label for="netBalance">Caja Neta de Undertango:</label>
            <input type="number" id="netBalance" value="900000" />
          </div>
          <div class="operational-balance">
            <label for="operationalBalance">Caja de Gastos Operativos:</label>
            <input type="number" id="operationalBalance" value="0" />
          </div>
          <div class="production-balance">
            <label for="productionBalance">Caja de Producción:</label>
            <input type="number" id="productionBalance" value="0" />
          </div>
        </div>
        <div class="month-panel">
          <h3>Archivos Mensuales</h3>
          <div id="month-buttons"></div>
        </div>
        <div id="monthlyRecords" class="month-records"></div>
        <h3>Registros Completados</h3>
        <div id="completedRecords"></div>
      </div>

      <!-- Panel Central -->
      <div class="middle-panel">
        <div class="category-management">
          <h3>Gestión de Categorías</h3>
          <div>
            <input type="text" id="newCategory" placeholder="Nueva Categoría" />
            <button onclick="addCategory()">Agregar Categoría</button>
          </div>
          <div class="category-actions">
            <select id="categoryToEdit">
              <option value="">Seleccione una categoría para editar</option>
            </select>
            <input
              type="text"
              id="editedCategory"
              placeholder="Nuevo nombre de categoría"
            />
            <button onclick="editCategory()">Guardar Cambios</button>
            <button onclick="deleteCategory()">Eliminar Categoría</button>
          </div>
        </div>
        <div class="category-input">
          <label for="category">Categoría:</label>
          <select id="category">
            <option value="">Seleccione una categoría</option>
          </select>
        </div>
        <div class="name-input">
          <label for="name">Nombre del Ingreso/Egreso:</label>
          <input type="text" id="name" />
        </div>
        <div class="date-input">
          <label for="date">Fecha:</label>
          <input type="date" id="date" />
        </div>
        <div class="amount-input">
          <label for="amount">Cantidad:</label>
          <input type="number" id="amount" />
        </div>
        <div class="source-select">
          <label for="source">Caja para Egreso:</label>
          <select id="source">
            <option value="">Seleccione una caja</option>
            <option value="operationalBalance">
              Caja de Gastos Operativos
            </option>
            <option value="productionBalance">Caja de Producción</option>
            <option value="netBalance">Caja Neta de Undertango</option>
          </select>
        </div>
        <div class="source-select">
          <label for="incomeSource">Caja para Ingreso:</label>
          <select id="incomeSource">
            <option value="">Seleccione una caja</option>
            <option value="netBalance">Caja Neta de Undertango</option>
            <option value="operationalBalance">
              Caja de Gastos Operativos
            </option>
            <option value="productionBalance">Caja de Producción</option>
          </select>
        </div>
        <div class="button-group">
          <button onclick="addRecord('egresos')">Agregar Egreso</button>
          <button onclick="addRecord('ingresos')">Agregar Ingreso</button>
          <button
            onclick="handleAutomaticDistribution()"
            style="background-color: #e6f3ff"
          >
            Agregar Ingreso con Distribución Automática
          </button>
          <!-- Modificado el botón de Transfusión -->
          <button onclick="processTransfer()">Transfusión</button>
        </div>

        <h2>Egresos</h2>
        <div id="egresosRecords"></div>

        <h2>Ingresos</h2>
        <div id="ingresosRecords"></div>

        <button onclick="saveEditedRecord()" style="margin-top: 20px">
          Guardar Cambios
        </button>
      </div>

      <!-- Panel Derecho -->
      <div class="right-panel">
        <!-- Contenedor React para los gráficos -->
        <div id="chartsContainer"></div>
      </div>
    </div>

    <!-- Modal para impuestos -->
    <div id="taxModal" class="modal">
      <div class="modal-content">
        <h3>¿El ingreso tiene impuestos?</h3>
        <div class="modal-buttons">
          <button onclick="handleTaxResponse(true)">Sí</button>
          <button onclick="handleTaxResponse(false)">No</button>
        </div>
      </div>
    </div>

    <!-- Modal para monto de impuestos -->
    <div id="taxAmountModal" class="modal">
      <div class="modal-content">
        <h3>Indique el monto del impuesto</h3>
        <input type="number" id="taxAmount" step="0.01" />
        <div class="modal-buttons">
          <button onclick="processTaxAmount()">Aceptar</button>
        </div>
      </div>
    </div>

    <!-- Modal para caché de artista -->
    <div id="cacheModal" class="modal">
      <div class="modal-content">
        <h3>Distribución del Caché de Artista</h3>
        <p id="cacheDistribution"></p>
        <div class="modal-buttons">
          <button onclick="closeModal('cacheModal')">Aceptar</button>
        </div>
      </div>
    </div>

    <script>
      // Variables globales
      let egresosRecords = [];
      let ingresosRecords = [];
      let completedRecords = [];
      let archivedRecords = {};
      let categories = [
        "Impuestos",
        "Caché de Artista",
        "Ingreso Automático",
        "Distribución Automática",
        "Transferencia",
      ];

      // Objeto para los balances
      let balances = {
        netBalance: 900000,
        operationalBalance: 0,
        productionBalance: 0,
      };

      let editingRecord = null;
      let editingType = null;

      document.addEventListener("DOMContentLoaded", function () {
        loadInitialData();
        renderRecords("egresos");
        renderRecords("ingresos");
        renderCompletedRecords();
        updateMonthButtons();
        updateCategoryDropdowns();
        setupBalanceEditing();
        // Inicializar los gráficos después de cargar los datos
        updateCharts();
      });

      function loadInitialData() {
        const savedBalances = localStorage.getItem("balances");
        const savedCategories = localStorage.getItem("categories");
        const savedEgresos = localStorage.getItem("egresosRecords");
        const savedIngresos = localStorage.getItem("ingresosRecords");
        const savedCompleted = localStorage.getItem("completedRecords");
        const savedArchived = localStorage.getItem("archivedRecords");

        if (savedBalances) balances = JSON.parse(savedBalances);
        if (savedCategories) categories = JSON.parse(savedCategories);
        if (savedEgresos) egresosRecords = JSON.parse(savedEgresos);
        if (savedIngresos) ingresosRecords = JSON.parse(savedIngresos);
        if (savedCompleted) {
          completedRecords = JSON.parse(savedCompleted);
          // Asegurarse de que todos los registros completados tengan 'addedToChart'
          completedRecords.forEach((record) => {
            if (record.addedToChart === undefined) {
              record.addedToChart = false;
            }
          });
        }
        if (savedArchived) archivedRecords = JSON.parse(savedArchived);

        updateBalanceDisplay();
      }

      function setupBalanceEditing() {
        const balanceInputs = document.querySelectorAll(
          '.balance-box input[type="number"]'
        );
        balanceInputs.forEach((input) => {
          input.addEventListener("change", function () {
            const balanceType = this.id;
            const newValue = parseFloat(this.value);
            if (!isNaN(newValue)) {
              balances[balanceType] = newValue;
              saveAllBalances();
              updateBalanceDisplay();
              updateCharts();
            }
          });
        });
      }

      function handleAutomaticDistribution() {
        const amount = parseFloat(document.getElementById("amount").value);
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        const selectedCategory = document.getElementById("category").value;

        if (!amount || !date || !name || !selectedCategory) {
          alert("Por favor complete todos los campos antes de continuar.");
          return;
        }

        document.getElementById("taxModal").style.display = "block";
      }

      function handleTaxResponse(hasTax) {
        document.getElementById("taxModal").style.display = "none";
        if (hasTax) {
          document.getElementById("taxAmountModal").style.display = "block";
        } else {
          processDistribution(0);
        }
      }

      function processTaxAmount() {
        const taxAmount = parseFloat(
          document.getElementById("taxAmount").value
        );
        if (isNaN(taxAmount)) {
          alert("Por favor ingrese un monto válido");
          return;
        }
        document.getElementById("taxAmountModal").style.display = "none";
        processDistribution(taxAmount);
      }

      function processDistribution(taxAmount) {
        const amount = parseFloat(document.getElementById("amount").value);
        const selectedCategory = document.getElementById("category").value;
        const netAmount = amount - taxAmount;

        const netBalanceAmount = netAmount * 0.1;
        const operationalAmount = netAmount * 0.3;
        const productionAmount = netAmount * 0.1;
        const cacheAmount = netAmount * 0.5;

        balances.netBalance += netBalanceAmount;
        balances.operationalBalance += operationalAmount;
        balances.productionBalance += productionAmount;

        updateBalanceDisplay();
        saveAllBalances();

        addAutomaticRecord(
          "ingresos",
          amount,
          selectedCategory,
          document.getElementById("name").value
        );

        if (taxAmount > 0) {
          addAutomaticRecord(
            "egresos",
            taxAmount,
            "Impuestos",
            "Impuestos",
            "netBalance"
          );
          balances.netBalance -= taxAmount;
          updateBalanceDisplay();
          saveAllBalances();
        }

        const biancaAmount = cacheAmount * 0.5;
        const pabloAmount = cacheAmount * 0.5;

        document.getElementById("cacheDistribution").innerHTML = `
          El 50% de caché de artista es $${cacheAmount.toFixed(2)}<br>
          25% para Bianca: $${biancaAmount.toFixed(2)}<br>
          25% para Pablo: $${pabloAmount.toFixed(2)}
        `;

        document.getElementById("cacheModal").style.display = "block";

        addAutomaticRecord(
          "egresos",
          biancaAmount,
          "Caché Bianca",
          "Caché Bianca",
          "netBalance"
        );
        addAutomaticRecord(
          "egresos",
          pabloAmount,
          "Caché Pablo",
          "Caché Pablo",
          "netBalance"
        );
        balances.netBalance -= biancaAmount + pabloAmount;
        updateBalanceDisplay();
        saveAllBalances();

        clearInputs();
        updateCharts();
      }

      function addCategory() {
        const newCategory = document.getElementById("newCategory").value.trim();

        if (newCategory && !categories.includes(newCategory)) {
          categories.push(newCategory);
          saveCategories();
          updateCategoryDropdowns();
          document.getElementById("newCategory").value = "";
        } else {
          alert("La categoría ya existe o está vacía.");
        }
      }

      function editCategory() {
        const categoryToEdit = document.getElementById("categoryToEdit").value;
        const editedCategory = document
          .getElementById("editedCategory")
          .value.trim();
        if (
          categoryToEdit &&
          editedCategory &&
          !categories.includes(editedCategory)
        ) {
          const index = categories.indexOf(categoryToEdit);
          if (index !== -1) {
            categories[index] = editedCategory;
            saveCategories();
            updateCategoryDropdowns();
            document.getElementById("editedCategory").value = "";
          }
        } else {
          alert(
            "Seleccione una categoría para editar y proporcione un nuevo nombre válido."
          );
        }
      }

      function deleteCategory() {
        const categoryToDelete =
          document.getElementById("categoryToEdit").value;
        if (categoryToDelete) {
          const index = categories.indexOf(categoryToDelete);
          if (index !== -1) {
            categories.splice(index, 1);
            saveCategories();
            updateCategoryDropdowns();
          }
        } else {
          alert("Seleccione una categoría para eliminar.");
        }
      }

      function updateCategoryDropdowns() {
        const categoryDropdowns = document.querySelectorAll(
          "#category, #categoryToEdit"
        );
        categoryDropdowns.forEach((dropdown) => {
          dropdown.innerHTML =
            '<option value="">Seleccione una categoría</option>';
          categories.sort().forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            dropdown.appendChild(option);
          });
        });
      }

      function addRecord(type) {
        const category = document.getElementById("category").value.trim();
        const name = document.getElementById("name").value.trim();
        const date = document.getElementById("date").value;
        const amount = parseFloat(
          document.getElementById("amount").value.trim()
        );

        if (category && name && date && amount) {
          if (type === "egresos") {
            const source = document.getElementById("source").value;
            if (!source) {
              alert("Seleccione una caja para el egreso.");
              return;
            }
            const newRecord = {
              id: Date.now().toString(),
              category,
              name,
              date,
              amount,
              paid: false,
              source,
              type,
              addedToChart: false, // Inicialmente no agregado al gráfico
            };
            egresosRecords.push(newRecord);
          } else if (type === "ingresos") {
            const incomeSource = document.getElementById("incomeSource").value;
            if (!incomeSource) {
              alert("Seleccione una caja para el ingreso.");
              return;
            }
            const newRecord = {
              id: Date.now().toString(),
              category,
              name,
              date,
              amount,
              paid: false,
              source: incomeSource,
              type,
              addedToChart: false, // Inicialmente no agregado al gráfico
            };
            ingresosRecords.push(newRecord);
          }

          saveAllData();
          renderRecords(type);
          updateCharts();
          clearInputs();
        } else {
          alert("Por favor complete todos los campos.");
        }
      }

      function addAutomaticRecord(
        type,
        amount,
        category,
        name = "Distribución Automática",
        source = null
      ) {
        const date = new Date().toISOString().split("T")[0];
        const newRecord = {
          id: Date.now().toString(),
          category,
          name,
          date,
          amount,
          paid: true,
          type,
          source,
          addedToChart: false, // Inicialmente no agregado al gráfico
        };

        if (type === "egresos") {
          egresosRecords.push(newRecord);
        } else {
          ingresosRecords.push(newRecord);
        }

        saveAllData();
        renderRecords(type);
      }

      function renderRecords(type) {
        const recordsContainer = document.getElementById(type + "Records");
        recordsContainer.innerHTML = "";
        const records = type === "egresos" ? egresosRecords : ingresosRecords;
        records.forEach((record) => {
          const recordElement = document.createElement("div");
          recordElement.classList.add("record");
          recordElement.innerHTML = `
            <div>
              <strong>Categoría:</strong> ${record.category} - 
              <strong>Nombre:</strong> ${record.name} - 
              <strong>Fecha:</strong> ${record.date} - 
              <strong>Cantidad:</strong> $${record.amount.toFixed(2)} - 
              <strong>Caja:</strong> ${getCajaName(record.source)}
            </div>
            <button onclick="completeRecord('${
              record.id
            }', '${type}')">Marcar como Completado</button>
            <button onclick="editRecord('${
              record.id
            }', '${type}')">Editar</button>`;
          recordsContainer.appendChild(recordElement);
        });
      }

      function getCajaName(source) {
        switch (source) {
          case "netBalance":
            return "Caja Neta de Undertango";
          case "operationalBalance":
            return "Caja de Gastos Operativos";
          case "productionBalance":
            return "Caja de Producción";
          default:
            return "N/A";
        }
      }

      function renderCompletedRecords() {
        const completedRecordsContainer =
          document.getElementById("completedRecords");
        completedRecordsContainer.innerHTML = "";
        completedRecords.forEach((record, index) => {
          const recordElement = document.createElement("div");
          recordElement.classList.add("record", "completed");
          recordElement.innerHTML = `
            <div>
              <strong>Categoría:</strong> ${record.category} - 
              <strong>Nombre:</strong> ${record.name} - 
              <strong>Fecha:</strong> ${record.date} - 
              <strong>Cantidad:</strong> $${record.amount.toFixed(2)} - 
              <strong>Tipo:</strong> ${
                record.type === "egresos"
                  ? "Egreso"
                  : record.type === "ingresos"
                  ? "Ingreso"
                  : "Transferencia"
              } - 
              <strong>Caja:</strong> ${getCajaName(record.source)} ${
            record.destination ? "-> " + getCajaName(record.destination) : ""
          }
            </div>
            ${
              !record.addedToChart
                ? `<button onclick="addRecordToChart(${index})">Agregar al Gráfico</button>`
                : `<span style="color: green; font-weight: bold;">Agregado al Gráfico</span>`
            }
            <button onclick="deleteCompletedRecord(${index})">Eliminar</button>
          `;
          completedRecordsContainer.appendChild(recordElement);
        });
      }

      function addRecordToChart(index) {
        if (completedRecords[index] && !completedRecords[index].addedToChart) {
          completedRecords[index].addedToChart = true;
          saveAllData();
          renderCompletedRecords();
          updateCharts();
          alert("Registro agregado a los gráficos exitosamente.");
        }
      }

      function completeRecord(id, type) {
        const records = type === "egresos" ? egresosRecords : ingresosRecords;
        const recordIndex = records.findIndex((record) => record.id === id);

        if (recordIndex !== -1) {
          const completedRecord = {
            ...records.splice(recordIndex, 1)[0],
            paid: true,
            addedToChart: false, // Inicialmente no agregado al gráfico
          };
          completedRecords.push(completedRecord);

          // Ajustar el balance aquí
          if (type === "egresos") {
            balances[completedRecord.source] -= completedRecord.amount;
          } else {
            balances[completedRecord.source] += completedRecord.amount;
          }

          saveAllData();
          renderRecords(type);
          renderCompletedRecords();
          updateCharts();
          updateBalanceDisplay();
        }
      }

      function deleteCompletedRecord(index) {
        const deletedRecord = completedRecords.splice(index, 1)[0];

        // Revertir los cambios en el balance
        if (deletedRecord.type === "egresos") {
          balances[deletedRecord.source] += deletedRecord.amount;
        } else if (deletedRecord.type === "ingresos") {
          balances[deletedRecord.source] -= deletedRecord.amount;
        } else if (deletedRecord.type === "transfer") {
          // Revertir transferencia
          balances[deletedRecord.source] += deletedRecord.amount;
          balances[deletedRecord.destination] -= deletedRecord.amount;
        }

        saveAllData();
        renderCompletedRecords();
        updateCharts();
        updateBalanceDisplay();
      }

      function saveAllData() {
        localStorage.setItem("egresosRecords", JSON.stringify(egresosRecords));
        localStorage.setItem(
          "ingresosRecords",
          JSON.stringify(ingresosRecords)
        );
        localStorage.setItem(
          "completedRecords",
          JSON.stringify(completedRecords)
        );
        localStorage.setItem(
          "archivedRecords",
          JSON.stringify(archivedRecords)
        );
        saveAllBalances();
        saveCategories();
      }

      function saveCategories() {
        localStorage.setItem("categories", JSON.stringify(categories));
      }

      function saveAllBalances() {
        localStorage.setItem("balances", JSON.stringify(balances));
      }

      function updateBalanceDisplay() {
        document.getElementById("netBalance").value =
          balances.netBalance.toFixed(2);
        document.getElementById("operationalBalance").value =
          balances.operationalBalance.toFixed(2);
        document.getElementById("productionBalance").value =
          balances.productionBalance.toFixed(2);
      }

      function clearInputs() {
        document.getElementById("category").value = "";
        document.getElementById("name").value = "";
        document.getElementById("date").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("source").value = "";
        document.getElementById("incomeSource").value = "";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Funciones para los gráficos con React y Chart.js manualmente
      function getChartData() {
        const completedRecordsFiltered = completedRecords.filter(
          (record) => record.addedToChart
        );
        const archivedRecordsFiltered = Object.values(archivedRecords);

        const expensesData = {};
        const incomesData = {};

        // Procesar registros completados
        completedRecordsFiltered.forEach((record) => {
          const data = record.type === "egresos" ? expensesData : incomesData;
          data[record.category] = (data[record.category] || 0) + record.amount;
        });

        // Procesar registros archivados que también tengan 'addedToChart: true'
        archivedRecordsFiltered.forEach((monthData) => {
          monthData.egresos.forEach((record) => {
            if (record.addedToChart) {
              expensesData[record.category] =
                (expensesData[record.category] || 0) + record.amount;
            }
          });
          monthData.ingresos.forEach((record) => {
            if (record.addedToChart) {
              incomesData[record.category] =
                (incomesData[record.category] || 0) + record.amount;
            }
          });
        });

        // Datos específicos para las cajas
        const ingresosOperacionales = completedRecordsFiltered
          .filter(
            (record) =>
              record.type === "ingresos" &&
              record.source === "operationalBalance"
          )
          .reduce((totals, record) => {
            totals[record.category] =
              (totals[record.category] || 0) + record.amount;
            return totals;
          }, {});

        const egresosOperacionales = completedRecordsFiltered
          .filter(
            (record) =>
              record.type === "egresos" &&
              record.source === "operationalBalance"
          )
          .reduce((totals, record) => {
            totals[record.category] =
              (totals[record.category] || 0) + record.amount;
            return totals;
          }, {});

        const ingresosProduccion = completedRecordsFiltered
          .filter(
            (record) =>
              record.type === "ingresos" &&
              record.source === "productionBalance"
          )
          .reduce((totals, record) => {
            totals[record.category] =
              (totals[record.category] || 0) + record.amount;
            return totals;
          }, {});

        const egresosProduccion = completedRecordsFiltered
          .filter(
            (record) =>
              record.type === "egresos" && record.source === "productionBalance"
          )
          .reduce((totals, record) => {
            totals[record.category] =
              (totals[record.category] || 0) + record.amount;
            return totals;
          }, {});

        const operationalData = {
          "Gastos Operativos": balances.operationalBalance,
        };
        const productionData = { Producción: balances.productionBalance };

        return {
          expenses: expensesData,
          incomes: incomesData,
          ingresosOperacionales: ingresosOperacionales,
          egresosOperacionales: egresosOperacionales,
          ingresosProduccion: ingresosProduccion,
          egresosProduccion: egresosProduccion,
          operational: operationalData,
          production: productionData,
        };
      }

      function getCategoryTotals(records) {
        return records.reduce((totals, record) => {
          totals[record.category] =
            (totals[record.category] || 0) + record.amount;
          return totals;
        }, {});
      }

      function updateCategoryTotals(totals, records) {
        records.forEach((record) => {
          totals[record.category] =
            (totals[record.category] || 0) + record.amount;
        });
      }

      // Exponer getChartData al ámbito global
      window.getChartData = getChartData;

      // Función para actualizar los gráficos desde React
      function updateCharts() {
        window.dispatchEvent(new Event("updateCharts"));
      }

      // Llamar a updateCharts después de cualquier cambio en los datos
      function showMonthlyRecords(month) {
        const monthStart = new Date(month.getFullYear(), month.getMonth(), 1);
        const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);

        const filteredEgresos = egresosRecords.filter((record) => {
          const recordDate = new Date(record.date);
          return recordDate >= monthStart && recordDate <= monthEnd;
        });

        const filteredIngresos = ingresosRecords.filter((record) => {
          const recordDate = new Date(record.date);
          return recordDate >= monthStart && recordDate <= monthEnd;
        });

        const monthlyRecordsContainer =
          document.getElementById("monthlyRecords");
        monthlyRecordsContainer.innerHTML = `
          <h3>Registros para ${month.toLocaleString("default", {
            month: "long",
            year: "numeric",
          })}</h3>
          <h4>Egresos</h4>
          ${
            filteredEgresos.length > 0
              ? filteredEgresos
                  .map(
                    (record) => `
              <div class="record">
                <strong>${record.name}</strong> - $${record.amount.toFixed(
                      2
                    )} - ${record.date}
              </div>
            `
                  )
                  .join("")
              : "<p>No hay egresos para este mes.</p>"
          }
          <h4>Ingresos</h4>
          ${
            filteredIngresos.length > 0
              ? filteredIngresos
                  .map(
                    (record) => `
              <div class="record">
                <strong>${record.name}</strong> - $${record.amount.toFixed(
                      2
                    )} - ${record.date}
              </div>
            `
                  )
                  .join("")
              : "<p>No hay ingresos para este mes.</p>"
          }
        `;

        // Archivar los registros filtrados
        const monthKey = `${month.getFullYear()}-${month.getMonth() + 1}`;
        archivedRecords[monthKey] = {
          egresos: filteredEgresos,
          ingresos: filteredIngresos,
        };

        // Guardar los registros archivados en localStorage
        localStorage.setItem(
          "archivedRecords",
          JSON.stringify(archivedRecords)
        );

        // Actualizar los gráficos para incluir los registros archivados
        updateCharts();
      }

      // Definir la función updateMonthButtons
      function updateMonthButtons() {
        const monthButtonsContainer = document.getElementById("month-buttons");
        monthButtonsContainer.innerHTML = "";

        const currentDate = new Date();
        for (let i = 0; i < 12; i++) {
          const month = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth() - i,
            1
          );
          const monthName = month.toLocaleString("default", {
            month: "long",
            year: "numeric",
          });
          const button = document.createElement("button");
          button.textContent = monthName;
          button.onclick = () => showMonthlyRecords(month);
          monthButtonsContainer.appendChild(button);
        }
      }

      // Definida la función processTransfer
      function processTransfer() {
        alert("Función de transfusión aún no implementada.");
        // Aquí puedes implementar la lógica de transferencia
      }

      // Definida la función editRecord
      function editRecord(id, type) {
        const records = type === "egresos" ? egresosRecords : ingresosRecords;
        const record = records.find((rec) => rec.id === id);
        if (record) {
          editingRecord = record;
          editingType = type;

          document.getElementById("category").value = record.category;
          document.getElementById("name").value = record.name;
          document.getElementById("date").value = record.date;
          document.getElementById("amount").value = record.amount;
          if (type === "egresos") {
            document.getElementById("source").value = record.source;
          } else {
            document.getElementById("incomeSource").value = record.source;
          }

          // Puedes cambiar el texto del botón de agregar a guardar cambios si lo deseas
          // Por simplicidad, mantenemos el botón "Guardar Cambios" separado
        }
      }

      function saveEditedRecord() {
        if (editingRecord && editingType) {
          const updatedCategory = document
            .getElementById("category")
            .value.trim();
          const updatedName = document.getElementById("name").value.trim();
          const updatedDate = document.getElementById("date").value;
          const updatedAmount = parseFloat(
            document.getElementById("amount").value.trim()
          );

          if (
            updatedCategory &&
            updatedName &&
            updatedDate &&
            !isNaN(updatedAmount)
          ) {
            editingRecord.category = updatedCategory;
            editingRecord.name = updatedName;
            editingRecord.date = updatedDate;
            editingRecord.amount = updatedAmount;
            if (editingType === "egresos") {
              editingRecord.source = document.getElementById("source").value;
            } else {
              editingRecord.source =
                document.getElementById("incomeSource").value;
            }

            saveAllData();
            renderRecords(editingType);
            renderCompletedRecords();
            updateCharts();
            clearInputs();
            editingRecord = null;
            editingType = null;
          } else {
            alert(
              "Por favor complete todos los campos para guardar los cambios."
            );
          }
        } else {
          alert("No hay ningún registro siendo editado.");
        }
      }
    </script>

    <!-- Contenedor React para los gráficos -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      function ChartComponent({ title, data, type }) {
        const chartRef = useRef(null);
        const chartInstanceRef = useRef(null);

        useEffect(() => {
          const ctx = chartRef.current.getContext("2d");

          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }

          const config = {
            type: type,
            data: {
              labels: Object.keys(data),
              datasets: [
                {
                  data: Object.values(data),
                  backgroundColor: [
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                    "#FF9F40",
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                    "#FF9F40",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                title: {
                  display: true,
                  text: title,
                },
              },
            },
          };

          chartInstanceRef.current = new Chart(ctx, config);
        }, [data, title, type]);

        return <canvas ref={chartRef}></canvas>;
      }

      function FinancialCharts({ getChartData }) {
        const [chartData, setChartData] = useState({
          expenses: {},
          incomes: {},
          ingresosOperacionales: {},
          egresosOperacionales: {},
          ingresosProduccion: {},
          egresosProduccion: {},
          operational: {},
          production: {},
        });

        useEffect(() => {
          function updateChartsData() {
            const newChartData = getChartData();
            setChartData(newChartData);
          }

          // Inicializar los datos de los gráficos
          updateChartsData();

          // Escuchar el evento 'updateCharts' para actualizar los gráficos
          window.addEventListener("updateCharts", updateChartsData);

          // Limpiar el listener al desmontar el componente
          return () => {
            window.removeEventListener("updateCharts", updateChartsData);
          };
        }, [getChartData]);

        return (
          <div className="charts-container">
            {/* Gráfico General de Egresos */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Distribución de Egresos"
                data={chartData.expenses}
                type="pie"
              />
            </div>
            {/* Gráfico General de Ingresos */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Distribución de Ingresos"
                data={chartData.incomes}
                type="pie"
              />
            </div>
            {/* Gráfico de Ingresos a Gastos Operativos */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Ingresos a Gastos Operativos"
                data={chartData.ingresosOperacionales}
                type="bar"
              />
            </div>
            {/* Gráfico de Egresos de Gastos Operativos */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Egresos de Gastos Operativos"
                data={chartData.egresosOperacionales}
                type="bar"
              />
            </div>
            {/* Gráfico de Ingresos a Caja de Producción */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Ingresos a Caja de Producción"
                data={chartData.ingresosProduccion}
                type="bar"
              />
            </div>
            {/* Gráfico de Egresos de Caja de Producción */}
            <div className="chart-wrapper">
              <ChartComponent
                title="Egresos de Caja de Producción"
                data={chartData.egresosProduccion}
                type="bar"
              />
            </div>
          </div>
        );
      }

      // Renderizar el componente FinancialCharts en el contenedor React
      ReactDOM.render(
        <FinancialCharts getChartData={() => window.getChartData()} />,
        document.getElementById("chartsContainer")
      );
    </script>
  </body>
</html>
