<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UnderTango Juego</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        display: flex;
      }
      /* Estilos para las barras laterales */
      .sidebar {
        width: 200px;
        background-color: #333;
        color: #fff;
        padding: 20px;
        box-sizing: border-box;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        margin-bottom: 10px;
      }
      .sidebar a:hover {
        text-decoration: underline;
      }
      /* Contenido principal */
      .main-content {
        flex: 1;
        padding: 20px;
        box-sizing: border-box;
        text-align: center;
      }
      /* Estilos para el ranking */
      .ranking {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .ranking li {
        background-color: #fff;
        margin-bottom: 5px;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }
      /* Ajustes para la barra derecha */
      .sidebar-right {
        width: 250px;
        background-color: #f9f9f9;
        color: #333;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      /* Estilos para los botones */
      .buttons-container {
        margin-top: 20px;
      }
      .buttons-container button {
        padding: 15px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #4285f4;
        color: #fff;
        margin: 5px;
      }
      .buttons-container button:hover {
        background-color: #357ae8;
      }
      /* Estilos para la información del usuario */
      .user-info img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Barra lateral izquierda -->
    <div class="sidebar">
      <h3>Menú</h3>
      <a href="#" id="editProfileLink">Editar Perfil</a>
      <!-- Puedes agregar más opciones aquí -->
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <div class="user-info">
        <h2 id="gameName"></h2>
        <p id="institution"></p>
        <img id="profilePhoto" src="" alt="Foto de perfil" />
        <p id="userCoins">Monedas de usuario: Cargando...</p>
        <p id="globalCoins">Monedas disponibles globalmente: Cargando...</p>
      </div>

      <div class="buttons-container">
        <button id="adventureMode">Modo Aventura</button>
        <button id="tradeMarket">TradeMarket</button>
        <button id="livingRoom">Living Room</button>
      </div>
    </div>

    <!-- Barra lateral derecha -->
    <div class="sidebar-right">
      <h3>Ranking de Jugadores</h3>
      <ul id="rankingList" class="ranking">
        <!-- Aquí se cargará el ranking -->
      </ul>
    </div>

    <script type="module">
      // Importar Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collectionGroup,
        query,
        orderBy,
        limit,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      // Configuración de Firebase (reemplaza con tu propia configuración)
      const firebaseConfig = {
        apiKey: "AIzaSyC05s84tQfQbiJua0G0LHnQsZP76HqxMk4",
        authDomain: "undertango.firebaseapp.com",
        projectId: "undertango",
        storageBucket: "undertango.appspot.com",
        messagingSenderId: "21199358960",
        appId: "1:21199358960:web:6b751db7c333403057ab35",
      };

      // Inicializar Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Mostrar la información en la página
      function mostrarInformacionUsuario(gameName, institution, photoURL) {
        document.getElementById("gameName").textContent = gameName || "Usuario";
        document.getElementById("institution").textContent =
          institution || "Institución";
        document.getElementById("profilePhoto").src =
          photoURL || "ruta_default.jpg";
      }

      // Función para obtener monedas del usuario y globales
      function obtenerDatosUsuarioYGlobales() {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            const userId = user.uid;

            // Referencias a documentos
            const userDocRef = doc(db, "usuarios", userId);
            const publicDataRef = doc(
              db,
              `usuarios/${userId}/publicData/perfilPublico`
            );

            try {
              // Obtener datos privados del usuario (monedas personales y institution)
              const userDoc = await getDoc(userDocRef);
              if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById(
                  "userCoins"
                ).textContent = `Monedas de usuario: ${
                  userData.undertangoCoins || 0
                }`;
                const institution = userData.institution || "Institución";
                // Almacenar institution en una variable para mostrarla después
                mostrarInformacionUsuario(null, institution, null);
              } else {
                console.error("No se encontró el documento del usuario.");
              }

              // Obtener datos públicos del usuario (gameName, photoURL)
              const publicDataDoc = await getDoc(publicDataRef);
              if (publicDataDoc.exists()) {
                const publicData = publicDataDoc.data();
                const gameName = publicData.gameName || "Usuario";
                const photoURL = publicData.photoURL || "ruta_default.jpg";
                mostrarInformacionUsuario(gameName, null, photoURL);
              } else {
                console.error(
                  "No se encontró el documento de datos públicos del usuario."
                );
              }

              // Obtener los datos globales (monedas disponibles globalmente)
              const globalesRef = doc(db, "globales", "contadores");
              const globalesDoc = await getDoc(globalesRef);
              if (globalesDoc.exists()) {
                const datosGlobales = globalesDoc.data();
                document.getElementById(
                  "globalCoins"
                ).textContent = `Monedas disponibles globalmente: ${
                  datosGlobales.totalCoinsDisponibles || 0
                }`;
              } else {
                console.error("No se encontró el documento global.");
              }

              // Obtener el ranking de jugadores
              obtenerRanking();
            } catch (error) {
              console.error("Error al obtener los datos: ", error);
            }
          } else {
            console.error("No hay un usuario autenticado.");
            window.location.href = "registro.html";
          }
        });
      }

      // Función para obtener el ranking de jugadores
      async function obtenerRanking() {
        try {
          const usuariosPublicDataRef = collectionGroup(db, "publicData");
          const q = query(
            usuariosPublicDataRef,
            orderBy("undertangoCoins", "desc"),
            limit(10)
          );
          const querySnapshot = await getDocs(q);
          const rankingList = document.getElementById("rankingList");
          rankingList.innerHTML = "";

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const li = document.createElement("li");
            li.textContent = `${data.gameName || "Usuario Anónimo"} - ${
              data.undertangoCoins || 0
            } monedas`;
            rankingList.appendChild(li);
          });
        } catch (error) {
          console.error("Error al obtener el ranking: ", error);
        }
      }

      // Llamar a la función para obtener datos de usuario y globales
      obtenerDatosUsuarioYGlobales();

      // Función para manejar la navegación con autenticación
      function navegarConAutenticacion(pagina) {
        const user = auth.currentUser;
        if (user) {
          window.location.href = pagina;
        } else {
          console.error("Debes iniciar sesión para acceder a esta página.");
          window.location.href = "registro.html";
        }
      }

      // Agregar event listeners a los botones
      document.getElementById("adventureMode").addEventListener("click", () => {
        window.location.href = "modo_aventura.html";
      });

      document.getElementById("tradeMarket").addEventListener("click", () => {
        navegarConAutenticacion("trademarket.html");
      });

      document.getElementById("livingRoom").addEventListener("click", () => {
        navegarConAutenticacion("living_room.html");
      });

      // Evento para el enlace "Editar Perfil"
      document
        .getElementById("editProfileLink")
        .addEventListener("click", () => {
          navegarConAutenticacion("formulario.html");
        });
    </script>
  </body>
</html>
